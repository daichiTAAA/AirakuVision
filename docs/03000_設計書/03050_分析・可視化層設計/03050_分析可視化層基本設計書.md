# 03050_分析可視化層基本設計書

## 1. 目的
本書は、分析可視化層の画面構成、操作フロー、データ連携を定義し、現場監督者、分析担当者、運用管理者が効率的に監視・分析・管理作業を行える設計を示す。

## 2. 適用範囲
- ライブ監視ダッシュボード（現場監督者向け）
- 作業イベント監視UI（現場監督者向け）
- 要素作業分析UI（分析担当者向け）
- 端末・順序管理UI（運用管理者向け）
- 運用管理ダッシュボード（運用管理者向け）
- 監査ログ閲覧UI（運用管理者向け）
- レポート出力と共有機能

## 3. 関連要件
- 機能：F-001, F-002, F-010, F-011, F-012, F-013, F-020, F-021, F-022, F-023, F-030, F-032, F-033, F-040, F-041, F-042, F-043, F-044, F-050, F-051, F-052, F-053
- 非機能：N-001, N-003, N-004, N-005, N-009, N-012, N-013, N-016, N-017, N-018, N-019, N-020, N-021
- データ：D-001, D-002, D-003, D-004, D-005, D-006, D-007, D-008, D-009
- インターフェース：I-001, I-003, I-004
- 運用・保守：O-001, O-002, O-003, O-004
- リスク：R-001, R-002, R-003

## 4. ユーザーシナリオ

### 4.1 現場監督者シナリオ
1. ライン監督者がライブ監視ダッシュボードにログインし、担当ラインの作業者状況を確認。
2. 映像配信の遅延やイベント登録異常があれば、アラートで即座に通知される。
3. 作業者が音声コマンドで登録したイベントを監視し、確認待ちステータスのイベントを承認・修正する。
4. 中断・再開が多発する作業者がいれば、詳細を確認し現場でサポートする。

### 4.2 分析担当者シナリオ
1. 分析担当者がログインし、担当ラインまたは月連番で対象動画を検索。
2. 動画を再生し、AI 候補区間を確認。必要に応じて開始・終了時刻やカテゴリを修正。
3. 追加ラベルを手動で入力し、保存。保存と同時に学習データ更新キューへ登録。
4. ラベリング結果をレポートで確認し、共有リンクを生成。
5. 作業履歴とレビューステータスを監督者が確認し、承認または差戻しを行う。

### 4.3 運用管理者シナリオ
1. 運用管理者が端末管理画面で新規端末を登録し、ライン割当と音声コマンド設定を行う。
2. CSV アップロード機能で順序リストを更新し、月連番と工程情報を管理する。
3. 運用ダッシュボードでシステム全体の稼働状況、ストレージ利用量、配信負荷を監視する。
4. 監査ログを定期確認し、不正アクセスや権限変更履歴をチェックする。

## 5. 画面構成

![画面遷移図](./画面遷移図.svg)

![Wireframe](./Wireframe.svg)

### 5.1 ライブ監視ダッシュボード（現場監督者向け）
レイアウト構成：
- 上部：ライン選択、リアルタイム時刻、アラート通知領域
- 中央メイン：
  - 左側：アクティブ端末一覧（端末名、作業者名、現在ステータス、最終イベント時刻）
  - 右側：選択端末のライブ映像表示（遅延時間表示付き）
- 下部：
  - 左側：リアルタイムイベントログ（最新20件、開始・終了・中断・再開）
  - 右側：統計サマリ（稼働端末数、配信異常、イベント異常件数）

機能：
- 端末クリックでライブ映像切替（F-010）
- 配信遅延が1秒を超過するとアラート表示（N-001）
- 音声認識失敗やプライバシーゾーン検知をリアルタイム通知（F-052）
- 確認待ちイベントの承認・修正（F-020, F-021）

### 5.2 作業イベント監視UI（現場監督者向け）
レイアウト構成：
- 上部：フィルタ（期間、ライン、端末、イベント種別、ステータス）
- 中央：イベント一覧テーブル
  - 列：タイムスタンプ、端末名、イベント種別、月連番、認識信頼度、ステータス、アクション
- 右側パネル：選択イベントの詳細（発話テキスト、工程情報、中断理由）
- 下部：ページネーション、エクスポート機能

機能：
- 認識信頼度が低いイベントのハイライト表示（D-008）
- 月連番照合エラーの警告表示（F-022）
- 中断・再開履歴の詳細表示（F-023）
- 一括承認・差戻し機能

### 5.3 要素作業分析UI（分析担当者向け）
レイアウト構成：
- 上部：動画再生プレーヤー（再生・一時停止・倍速・スロー・区間ループ）
- 左側：AI 候補区間リスト（開始・終了、カテゴリ、信頼度、ステータス）
- 中央下部：タイムライン（ラベル帯表示、ズーム、マーカー移動）
- 右側：編集フォーム（カテゴリ、タグ、備考、プライバシーフラグ）
- 下部ステータスバー：現在時間、ショートカットヘルプ、保存状態

### 5.4 端末・順序管理UI（運用管理者向け）
#### 5.4.1 端末管理画面
レイアウト構成：
- 上部：新規端末登録ボタン、一括インポート、検索フィルタ
- 中央：端末一覧テーブル
  - 列：端末識別子、端末名、所属ライン、状態、最終同期時刻、アクション
- 右側：選択端末の詳細設定（許可音声コマンド、プライバシーゾーン設定）

機能：
- 端末の登録・更新・削除（F-001）
- 月連番の参照・上書き（F-002）
- バッテリー状態と連続稼働時間の監視（N-015）

#### 5.4.2 順序データ管理画面
レイアウト構成：
- 上部：CSV アップロード、手動登録、バッチ処理状況
- 中央：順序リスト一覧（生産指示日、工程、型式、月連番、優先度、ステータス）
- 下部：整合性チェック結果、エラーレポート

機能：
- 順序データの取り込み・更新（F-032）
- 月連番の重複・抜け検知（D-007）
- 過去データとの照合・検証

### 5.5 運用管理ダッシュボード（運用管理者向け）
レイアウト構成：
- 上部：システム全体ステータス、重要アラート領域
- 中央4分割：
  - 左上：端末接続状況（接続数、オフライン数、バッテリー低下）
  - 右上：配信・録画状況（アクティブストリーム数、遅延統計、エラー率）
  - 左下：ストレージ利用量（容量、録画ファイル数、予測残存期間）
  - 右下：システムリソース（CPU、メモリ、ネットワーク）
- 下部：最新アラート履歴、メンテナンス予定

機能：
- リアルタイムメトリクス表示（F-053）
- 閾値超過時の自動アラート（O-001）
- 稼働率レポートの生成（N-004）

### 5.6 監査ログ閲覧UI（運用管理者向け）
レイアウト構成：
- 上部：検索フィルタ（期間、ユーザー、操作種別、対象リソース）
- 中央：ログ一覧テーブル
  - 列：タイムスタンプ、ユーザー、操作、対象、IPアドレス、結果
- 右側：選択ログの詳細（変更前後の値、セッション情報）

機能：
- 主要操作の記録・検索（F-051）
- 権限変更履歴の追跡（N-009）
- 映像閲覧ログの監視（N-012）

### 5.7 共通レポート画面
- フィルタ：期間、ライン、工程、カテゴリ
- 指標：要素作業時間、ばらつき、ボトルネック、確認待ち件数
- エクスポート：PDF/CSV、共有リンク生成

## 6. 機能詳細

### 6.1 ライブ監視機能
- WebSocket接続によるリアルタイム更新（映像配信状況、イベント通知）
- 配信遅延の自動監視と閾値超過アラート（N-001）
- プライバシーゾーン検知時の自動配信停止・再開表示（F-003）
- 音声認識失敗時の確認プロンプト状況表示（F-013）

### 6.2 イベント監視・管理機能
- 認識信頼度に基づく自動分類と優先度表示（D-008）
- 月連番と順序リストの照合結果表示（F-022）
- 中断・再開の理由記録と履歴表示（F-023）
- 一括承認機能による効率的なイベント処理

### 6.3 要素作業分析機能
- マウス操作またはキーボードショートカットで区間を設定。
- 登録時にカテゴリ・備考を入力し、保存ボタンで確定。保存成功時にトースト通知。
- ラベルはバージョン管理され、差分表示が可能。

#### 6.3.1 AI 候補区間機能
- 候補は信頼度順に表示し、状態は「未確認」「承認」「修正」「破棄」。
- 承認時は開始・終了・カテゴリをそのまま採用、修正時は編集フォームで値を変更。
- 候補の学習利用可否を選択でき、修正内容は差分学習に使用。

#### 6.3.2 レビュー機能
- レビュー担当者は変更履歴を参照し、承認または差戻しを実行。
- 差戻し時は理由を必須入力とし、担当者へ通知。
- 承認済みラベルはロックされ、再編集には再申請が必要。

### 6.4 端末・順序管理機能
- 端末の一括登録とCSVインポート・エクスポート（F-001）
- 月連番の自動採番と手動上書き（F-002）
- 順序データの定期取り込みとバッチ処理（F-032）
- データ整合性チェックとエラー検知（D-007）

### 6.5 運用監視機能
- システムメトリクスの収集と可視化（F-053）
- 閾値設定とアラート自動送信（O-001）
- 稼働率レポートの自動生成（N-004）
- バックアップ状況と災害対策状況の監視（O-004）

### 6.6 監査・セキュリティ機能
- 全操作の詳細ログ記録（F-051）
- 権限変更の承認ワークフロー（N-009）
- 映像閲覧の理由記録と期限管理（N-012）
- 不正アクセス検知とアラート

### 6.7 レポート出力機能
- レポート生成は非同期で処理し、完了時に通知。
- KPI は事前に定義したメトリクスセットに基づき算出。
- 公開リンクは期限付きトークンで保護し、アクセスログを記録。

## 7. データ連携
| データ               | 取得元               | 利用先                               | 備考                     |
| -------------------- | -------------------- | ------------------------------------ | ------------------------ |
| ライブ映像ストリーム | 配信・記録層         | ライブ監視UI                         | WebRTC/WHEPプロトコル    |
| 端末接続状況         | 配信・記録層         | 運用管理ダッシュボード               | リアルタイム監視         |
| 作業イベント         | 業務サービス層       | イベント監視UI                       | WebSocket通知            |
| 端末マスタ           | 業務サービス層       | 端末管理UI                           | D-001                    |
| 順序データ           | 業務サービス層       | 順序管理UI                           | D-002                    |
| 録画メタデータ       | データマネジメント層 | 分析UI、レポート                     | D-004                    |
| AI 候補区間          | 学習サービス         | 分析UI                               | 信頼度、モデルバージョン |
| ラベル結果           | 分析UI               | データマネジメント層、業務サービス層 | D-005                    |
| システムメトリクス   | 運用監視層           | 運用管理ダッシュボード               | Prometheus経由           |
| 監査ログ             | 全システム層         | 監査ログUI                           | 統一ログフォーマット     |
| レポート指標         | データマネジメント層 | レポートUI                           | 定期同期                 |

## 8. 非機能設計
- **操作性**：主要アクション 3 ステップ以内、キーボードショートカット対応。（N-020）
- **表示**：高コントラストテーマとナイトモードを用意。（N-021）
- **性能**：
  - 映像配信遅延 1 秒以内（N-001）
  - 作業イベント反映 1 秒以内（N-003）
  - 動画ロード 3 秒以内、タイムラインズーム 0.5 秒以内
  - 同時接続数 50 セッション対応（N-002）
- **信頼性**：
  - 自動保存機能で 30 秒間隔のドラフト保存（N-016）
  - 稼働率 99.5% 以上（N-004）
  - 5 分以内のフェイルオーバー（N-005）
- **セキュリティ**：
  - 通信暗号化（N-007）
  - 多要素認証（N-008）
  - 最小権限管理（N-009）
  - プライバシーゾーン対応（N-010）

## 9. セキュリティ
- **認証・認可**：
  - ロールベースアクセス制御で「現場監督者」「分析担当者」「レビュー担当」「運用管理者」に権限を限定（F-050, N-009）
  - 多要素認証による安全なログイン（N-008）
- **データ保護**：
  - 映像・音声データの閲覧には理由記録と期限付き承認が必要（N-012）
  - プライバシーゾーンデータの即時破棄（N-010）
  - データ保持期間の自動管理（N-011）
- **監査**：
  - 全操作ログの監査ログサービス送信（F-051）
  - 共有リンクの公開期限とアクセス回数制限（N-012）
  - 権限変更の承認ワークフロー（N-009）

## 10. 運用・保守
- **教育・トレーニング**：
  - 操作マニュアルとチュートリアルによる教育時間 30 分以内の達成（N-019, R-003）
  - 音声コマンド語彙の訓練時間 30 分以内（N-019）
- **監視・保守**：
  - 監視項目：ページロード時間、保存エラー率、レポート生成時間、配信遅延（O-001）
  - 閾値超過で運用チームへ自動通知
  - UI リリース前のアクセシビリティレビュー実施（O-003）
- **バージョン管理**：
  - 計画停止時間の事前周知（N-014）
  - 端末とサーバのバージョン互換性管理（O-002）
  - 定期メンテナンス手順とロールバック計画の文書化（O-003）
- **災害対策**：
  - 別拠点バックアップ複製と復旧訓練（O-004）
  - オフライン時のデータ一時保存と自動同期（N-016）

## 11. リスク対応
- **R-001（音声認識精度低下）**：
  - 騒音環境での認識失敗アラート表示
  - 補助入力装置インターフェースの準備
  - 確認プロンプト機能の活用
- **R-002（ネットワーク帯域不足）**：
  - 配信遅延の リアルタイム監視とアラート
  - 帯域監視ダッシュボードでの事前察知
  - 動的ビットレート制御状況の表示
- **R-003（ラベリング負荷増大）**：
  - 作業キュー自動割当による担当者間の負荷均等配分
  - AI候補区間提示による効率化
  - 教育用ガイドとチュートリアルの充実
- **R-004（法規制変更）**：
  - プライバシー関連設定の構成ファイル化
  - 運用ポリシー変更の迅速な反映機能
  - データ保持期間の柔軟な設定変更
- **追加リスク対応**：
  - UI 改修時の混乱防止：変更点のアプリ内告知、旧 UI への一時切替機能
  - システム障害時の業務継続：オフライン機能、手動記録機能の提供

---
本設計を基に詳細 UI 仕様とモックアップを作成する。各UI間の連携とロールベースの画面遷移も併せて詳細化すること。
