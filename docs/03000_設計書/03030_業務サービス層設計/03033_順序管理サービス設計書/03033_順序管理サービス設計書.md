# 順序管理サービス設計書

## 1. 目的
順序管理サービスは、生産指示日・工程・型式・月連番などの順序情報を集中管理し、作業イベントや分析の基礎となる整合性の取れたデータを提供する。本書は順序管理サービスの機能・データ・インターフェース設計を明確化し、他サービスとの連携手順を定義する。

## 2. 適用範囲
- 順序データ取り込み（バッチ／手動）
- 順序データ検索・照会・更新
- 月連番との照合 API
- 順序進捗・優先度管理
- データマネジメント層・作業イベントサービスへの提供

## 3. 関連要件
- 機能：F-020, F-022, F-031, F-032, F-033, F-044, F-052
- 非機能：N-003, N-007, N-008, N-014, N-017, N-018
- データ：D-001, D-002, D-003, D-007, D-009
- インターフェース：I-001, I-002, I-003
- 運用・保守：O-001, O-002, O-003, O-004
- リスク：R-002, R-003, R-004

## 4. サービスアーキテクチャ
- 実装：FastAPI + PostgreSQL（partitioned table by instruction_date）。バッチ処理は Prefect/Celery。
- コンポーネント：
  - `ImportManager`：CSV/Excel/SFTP からの取り込み、スキーマ検証を実施。
  - `SequenceRepository`：順序データ CRUD。
  - `MatchingEngine`：月連番照合ロジック。作業イベントサービスへ API/Async 呼び出しを提供。
  - `PriorityScheduler`：ライン・工程別に優先度を算出し、通知サービスと連携。
  - `MetricsCollector`：欠番・滞留状況を計測し、運用監視へ送信。

## 5. データモデル
| テーブル | 主キー | 主な項目 | 説明 |
|----------|--------|----------|------|
| production_sequences | sequence_id (UUID) | instruction_date, line_id, process_code, product_code, variant_code, machine_no, month_serial, planned_start_at, planned_end_at, status, priority, remarks | 順序基本情報。|
| sequence_history | history_id | sequence_id, old_status, new_status, changed_by, changed_at, comment | 状態変更履歴。|
| sequence_assignments | assignment_id | sequence_id, analyst_id, assigned_at, due_at | 分析担当割当情報。|
| sequence_import_jobs | job_id | source_type, file_name, row_count, success_count, failure_count, status, started_at, finished_at | 取り込みジョブログ。|
| sequence_validation_results | validation_id | job_id, row_number, error_code, field, message | 取り込み検証結果。|

## 6. データ取り込み設計
### 6.1 フロー
1. 運用担当が管理 UI からファイルをアップロード、または SFTP に配置。
2. `ImportManager` がスキーマ（JSON Schema）検証。必須項目欠落・型不整合は `sequence_validation_results` に記録。
3. 正常レコードをステージングテーブルへロード後、差分比較し `production_sequences` を更新。既存レコードとの差分はアップサート。
4. 更新結果を作業イベントサービス・データマネジメント層へ通知。欠番または重複が検知された場合は警告通知を発行。

### 6.2 スキーマ要件
- 必須：instruction_date, line_id, process_code, product_code, month_serial, planned_start_at。
- オプション：variant_code, inspector, remarks。
- 検証：月連番（1〜999）、日付形式 ISO8601、line_id 正規表現、process_code マスタ存在確認。

## 7. API 設計
| API ID | メソッド | パス | 機能 | 主な入力 | 主な出力 |
|--------|----------|------|------|----------|----------|
| API-040 | GET | /v1/production-sequences | 検索 | date_range, line_id, process_code, status, keyword, page | sequences[], pagination |
| API-041 | GET | /v1/production-sequences/{id} | 詳細 | sequence_id | sequence, history |
| API-042 | POST | /v1/production-sequences/import | ファイル登録 | upload_id, source_type | job_id, status |
| API-043 | GET | /v1/production-sequences/import/{job_id} | 取り込み結果 | job_id | job_status, errors[] |
| API-044 | PATCH | /v1/production-sequences/{id} | ステータス更新 | status, priority, remarks | sequence_id, updated_at |
| API-045 | POST | /v1/production-sequences/match | 月連番照合 | device_id, month_serial, occurred_at | match_status, sequence_id, expected_state |
| API-046 | GET | /v1/production-sequences/statistics | KPI 取得 | line_id, date_range | backlog_count, on_time_rate, overdue_sequences |

`API-045` は作業イベントサービスから同期呼び出しされ、キャッシュヒット時は 50ms 以内で応答。ミスマッチ時は `match_status=NOT_FOUND` を返し、補正候補と理由を含める。

## 8. 状態管理
| ステータス | 説明 | 遷移トリガー |
|------------|------|--------------|
| PLANNED | 取り込み直後 | 初期状態 |
| READY | 作業者待機 | 予定開始時刻到達、必要条件充足 |
| IN_PROGRESS | 作業進行中 | 作業イベント RUNNING 登録 |
| PAUSED | 一時停止 | 作業イベント PAUSED |
| COMPLETED | 完了 | 作業イベント COMPLETED |
| CANCELLED | 中止 | 手動取消または指示変更 |
| ARCHIVED | アーカイブ | 完了後保持期限経過 |

状態遷移は `sequence_history` に記録し、通知サービスと監査ログサービスへ連携。

## 9. バッチ処理
| ジョブ | 周期 | 機能 |
|--------|------|------|
| JOB-11 | 毎日 00:30 | SFTP からの順序ファイル取り込み（PL-03）|
| JOB-12 | 5 分 | 月連番欠番・重複検査、アラート発行（D-007）|
| JOB-13 | 1 時間 | 予定 vs 実績乖離レポート生成、可視化層へ提供 |
| JOB-14 | 毎週 | 古い検証結果の削除、監査ログへの集約 |

## 10. 非機能設計
- 性能：取り込みファイル最大 50,000 行。検証 + アップサートで 5 分以内完了。
- 可用性：取り込みジョブはリトライ（最大 3 回）。ジョブ失敗時は通知サービスへ緊急通知。
- データ品質：検証レポートを自動生成し、エラー率 >5% で import 全体をロールバック。
- 拡張性：追加フィールドは JSONB `extensions` に格納し、移行容易性を確保。

## 11. セキュリティ・監査
- 取り込みファイルはウイルススキャン後に保存。保管期間 30 日。
- API は OAuth2 + RBAC。照会は supervisor 以上、更新は admin のみ。
- 全操作を監査ログサービスへ送信（job_id, actor, result）。
- データ暗号化：月連番・製品コードなど機微情報を暗号化ストレージに保存。

## 12. 監視・運用
- メトリクス：取り込み成功率、重複検出件数、マッチングレスポンスタイム。
- アラート：
  - 連続ジョブ失敗 2 回 → 重大アラート。
  - 欠番検出 > 10 件 → 高優先度通知。
  - マッチング遅延 P95 > 200ms → 性能アラート。
- 運用手順：取り込みスケジュール調整、例外データの手動補正、監査レポート出力。

## 13. テスト観点
- 正常取り込み（CSV/Excel）、差分更新。
- 異常検証（必須列欠落、重複、型不一致）。
- マッチング応答（存在・未存在・重複）。
- 状態遷移トリガー（作業イベント連携）。
- 取り込み失敗時のロールバック。

## 14. リスク対応
- R-002：帯域不足で取り込み遅延 → SFTP 接続と API 取り込みを分離し、圧縮転送を採用。遅延検知で通知。
- R-003：ラベリング負荷偏在 → `sequence_assignments` で担当者を自動割当し、作業キューを可視化層へ提供。
- R-004：規制変更 → データ保持期間・マスキングルールを設定ファイルで管理し、変更時の再処理手順を整備。

---
本設計を基に OpenAPI 定義、取り込みテンプレート、バリデーションルール、運用 Runbook を作成する。
