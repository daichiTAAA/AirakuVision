# 作業イベントサービス設計書

## 1. 目的
作業イベントサービスは、装着型デバイスおよび運用 UI から送信される作業開始・終了・中断・再開等のイベントを統合的に管理し、順序情報や映像メタデータとの整合性を維持する。本書は当サービスの機能・データ・インターフェース設計ならびに非機能要件への対応方針を定義し、詳細設計・実装・テストの基礎とする。

## 2. 適用範囲
- 作業イベント API 群（登録・照会・更新・検索）
- イベント状態遷移ロジック・冪等制御
- 順序管理サービス・配信記録層・データマネジメント層との連携
- 通知・監査ログへのイベント連携

## 3. 関連要件
- 機能：F-020, F-021, F-022, F-023, F-030, F-031, F-033, F-043, F-052
- 非機能：N-003, N-007, N-008, N-009, N-014, N-016, N-018
- データ：D-003, D-004, D-005, D-007, D-008, D-009
- インターフェース：I-001, I-002, I-004
- 運用・保守：O-001, O-002, O-003
- リスク：R-001, R-003, R-004

## 4. サービスアーキテクチャ
- 実装基盤：FastAPI + PostgreSQL。API Gateway 経由で認証・レート制御を実施。
- 内部コンポーネント：
  - `CommandHandler`：登録・状態遷移リクエストの検証と実行。
  - `SequenceValidator`：順序管理サービスの gRPC/REST クライアント。月連番・工程整合性を検証。
  - `StateMachine`：状態遷移ルールを定義（表 1 参照）。
  - `EventPublisher`：通知サービスおよびデータマネジメント層向けに Kafka イベントを発行。
  - `AuditLogger`：監査ログサービスへ操作情報を送信。
- データストア：PostgreSQL（本番：可用性のためマルチ AZ）。イベント履歴はパーティションテーブルで月次分割。
- キャッシュ：日次の順序情報を Redis にキャッシュし、参照性能を向上。

## 5. ドメインモデル
| エンティティ | 主キー | 主な属性 | 説明 |
|--------------|--------|----------|------|
| work_events | event_id (UUID) | device_id, sequence_id, month_serial, event_type, state, occurred_at, confidence, source, version | 作業イベント本体。現在状態を保持。|
| work_event_transitions | transition_id (UUID) | event_id, from_state, to_state, reason_code, transitioned_at, actor | 状態遷移履歴。監査・再処理用。|
| work_event_metadata | event_id | recording_id, sequence_id (nullable), binding_status, anomaly_flag, linked_at | 録画動画と作業イベントの紐付け状態と再結合情報を保持（詳細メタは production_sequences を参照）。|
| event_acknowledgements | ack_id (UUID) | event_id, ack_type, acknowledged_by, acknowledged_at | 確認待ち（低信頼度）イベントの承認履歴。|

## 6. 状態遷移設計
| 遷移元 | 遷移先 | トリガー | 条件 | 備考 |
|--------|--------|----------|------|------|
| CREATED | RUNNING | 開始イベント登録 | 同一月連番の既存 RUNNING なし | 初回登録時。|
| RUNNING | PAUSED | 中断イベント登録 | 端末状態=ACTIVE | 中断理由を付与。|
| PAUSED | RUNNING | 再開イベント登録 | 中断時間が閾値内 | 長期中断は通知対象。|
| RUNNING | COMPLETED | 終了イベント登録 | 順序情報が存在し、イベント時刻が有効 | 正常完了。|
| RUNNING | CANCELLED | 取消要求 | 承認者ロールによる取消 | 誤登録対応。|
| 任意 | ERROR | 異常検知タスク | 必須属性欠落・整合性違反 | 自動再処理または手動補正。

状態遷移は `StateMachine` で定義し、違反時は HTTP 422 を返す。並列更新は `version` 列で楽観ロック管理。

## 7. API 設計概要
| API ID | メソッド | パス | 機能 | 主なリクエスト項目 | 主なレスポンス項目 |
|--------|----------|------|------|--------------------|--------------------|
| API-001 | POST | /v1/work-events | 作業イベント登録 | device_id, event_type, month_serial, occurred_at, confidence, source, idempotency_key | event_id, state, warnings |
| API-002 | POST | /v1/work-events/bulk | バッチ登録 | events[]（API-001 の配列） | 成功数、失敗詳細 |
| API-003 | PATCH | /v1/work-events/{id}/state | 状態遷移 | to_state, reason_code, actor | event_id, state, transitioned_at |
| API-004 | GET | /v1/work-events/{id} | 詳細取得 | event_id | event, transitions, metadata |
| API-005 | GET | /v1/work-events | 検索 | date_range, device_id, sequence_id, state, anomaly_flag, page | イベント一覧（ページング） |
| API-006 | POST | /v1/work-events/{id}/acknowledge | 確認承認 | ack_type, comment | ack_id, status |
| API-007 | POST | /v1/work-events/{id}/attachments | 添付登録 | attachment_url, type | attachment_id |

### 7.1 リクエスト検証
- `idempotency_key`：同一キーは 24 時間保持し、重複登録を防止。（N-016）
- `occurred_at`：端末時刻とサーバ時刻の許容差 ±120 秒。超過時は警告付きで登録。
- `month_serial`：順序管理サービスへ照会し、一致しない場合は `status=WARNING` で登録しつつ通知サービスへ連携。

### 7.2 レスポンス・エラー
- 成功時 HTTP 201（API-001,002,007）、200（API-003,004,005,006）。
- 代表的エラー：400（バリデーション）、404（存在しないイベント）、409（楽観ロック衝突）、422（状態遷移違反）、503（順序サービス・配信層連携失敗）。

## 8. 処理フロー
1. 装着型デバイスが API Gateway を経由して API-001 をコール。
2. `CommandHandler` が JSON 構造・署名トークンを検証。
3. `SequenceValidator` が順序管理サービスへ REST/gRPC リクエスト。結果キャッシュを更新。
4. 状態遷移チェックを通過後、トランザクション内で `work_events` と `work_event_transitions` を永続化。
5. コミット成功後、`EventPublisher` が Kafka トピック `work-events` へメッセージ送信。配信・記録層、データマネジメント層、通知サービスが購読。
6. `AuditLogger` が監査ログサービスへ API 操作を送出。

低信頼度イベントは `EventPublisher` が `event_acknowledgements` 用トピックに送信し、ライン監督者へ通知。

## 9. バッチ・スケジュール
| ジョブ ID | 周期 | 機能 | 備考 |
|-----------|------|------|------|
| JOB-01 | 5 分 | 順序リストとの差分検出、ステータス更新 | 欠番・重複検出（D-007）。|
| JOB-02 | 1 時間 | 映像メタデータ突合、未紐付けイベント検出 | 配信・記録層連携（D-004）。|
| JOB-03 | 1 日 | 古い idempotency キーとドラフトイベントの削除 | N-016 対応。|

## 10. 非機能設計
- 性能：API-001 平均応答 700ms 以下、P95 1.2s 以下。1 秒あたり 30 リクエストを想定し、オートスケール。
- 可用性：アクティブ-アクティブ構成で 99.9% 稼働。DB は同期レプリケーション。
- 信頼性：異常イベントはデッドレターキューに送信し、再処理ワーカーが対応。
- 監視：OpenTelemetry Exporter で遅延、エラー率、順序照合失敗率を収集。閾値超過時は通知サービス経由でアラート。

## 11. セキュリティ・監査
- 認可：OAuth2 アクセストークンとロール（analyst, supervisor, admin）。端末はデバイス証明書 + クライアントクレデンシャル。
- 入力署名検証：装着型デバイスは署名付きペイロードを送信し、改ざん検知を実施。（N-007）
- 監査ログ：全 API のリクエスト ID、呼出者、パラメータ概要、結果を記録。（F-051）
- データ保護：個人識別情報を含むフィールドは保存時に暗号化（PGP カラム暗号）。

## 12. テスト観点
- 正常系：各イベント種別の登録、順序一致・不一致、低信頼度フロー。
- 異常系：重複送信、時刻乖離、状態遷移違反、順序サービス障害、DB 障害。
- 性能試験：ピーク時 1800 req/min、遅延測定。idempotency キャッシュ性能。
- 可用性試験：片系停止時のフェイルオーバー、再処理タスク復元。

## 13. リスクと対策
- R-001：音声認識誤り → 低信頼度フラグと確認待ちキューを提供。手動補正 UI を順序管理と連携。
- R-003：ラベリング負荷過多 → 未確認イベントを優先度順に並び替え、分析 UI キューへ連携。
- R-004：規制変更 → 状態保持期間を設定ファイル化し、保持ポリシーを動的変更可能とする。

---
本設計を基に詳細 API スキーマ（OpenAPI）、バリデーションルール、監視ダッシュボード定義を整備する。
