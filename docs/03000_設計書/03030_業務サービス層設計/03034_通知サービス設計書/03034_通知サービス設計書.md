# 通知サービス設計書

## 1. 目的
通知サービスは、作業イベント・順序異常・端末状態・分析タスクなどの情報を関係者へ適時に配信し、迅速な対応を支援する。本書は通知サービスの機能設計、チャネル設計、配信制御および運用手順を定義する。

## 2. 適用範囲
- 通知テンプレート管理
- 通知要求キューイングと優先度制御
- 配信チャネル（メール、チャット、ダッシュボード、音声合成）
- 通知履歴・再送制御
- 運用監視・エスカレーション連携

## 3. 関連要件
- 機能：F-052, F-053, F-044, F-051
- 非機能：N-004, N-005, N-017, N-018, N-020, N-021
- データ：D-003, D-004, D-005, D-009
- インターフェース：I-003, I-004
- 運用・保守：O-001, O-002, O-003, O-004
- リスク：R-002, R-003, R-004

## 4. サービスアーキテクチャ
- 実装：FastAPI + Celery ワーカー。メッセージキューに Kafka、バックエンド DB に PostgreSQL を使用。
- コンポーネント：
  - `NotificationGateway`：業務サービス層からの通知 API を受信。優先度判定・バリデーションを行う。
  - `TemplateEngine`：Jinja2 ベースでテンプレートと差込データをレンダリング。
  - `Dispatcher`：チャネル別アダプタ（`EmailAdapter`, `ChatAdapter`, `WebhookAdapter`, `TTSAdapter`）。
  - `Scheduler`：遅延通知・再送スケジューリングを担当。
  - `PreferenceManager`：ユーザー・ロール別通知設定を管理。
  - `AuditEmitter`：通知履歴を監査ログサービスへ送信。

## 5. 通知カテゴリと優先度
| カテゴリ | 例 | デフォルト優先度 | 送信 SLA |
|----------|----|------------------|----------|
| OPERATIONS | 端末オフライン、配信遅延、メトリクス閾値 | HIGH | 30 秒以内 |
| QUALITY | 月連番不整合、要素作業承認待ち | MEDIUM | 5 分以内 |
| COMPLIANCE | プライバシー違反、監査完了通知 | HIGH | 30 秒以内 |
| REPORT | KPI レポート、ダッシュボード更新 | LOW | 30 分以内 |
| USER_ACTION | 作業イベント確認依頼、承認待ち | MEDIUM | 2 分以内 |

Priority に応じてリトライ回数・エスカレーションを制御。HIGH は最大 5 回、指数バックオフ。LOW は 2 回。

## 6. API 設計
| API ID | メソッド | パス | 機能 | 主な入力 | 主な出力 |
|--------|----------|------|------|----------|----------|
| API-050 | POST | /v1/notifications | 通知要求登録 | category, priority, audience, payload, options | notification_id |
| API-051 | GET | /v1/notifications/{id} | 詳細取得 | notification_id | status, attempts, history |
| API-052 | GET | /v1/notifications | 検索 | category, status, date_range, audience | notifications[], pagination |
| API-053 | POST | /v1/notifications/test | チャネルテスト | channel_id, payload | result |
| API-054 | POST | /v1/notifications/preferences | 通知設定登録 | user_id/role, category, channel, delivery_window | preference_id |
| API-055 | GET | /v1/notifications/templates/{id} | テンプレート取得 | template_id | template |
| API-056 | PUT | /v1/notifications/templates/{id} | テンプレート更新 | subject, body, variables | updated_at |

`audience` は `users[]` `roles[]` `webhook_urls[]` の組合せ。Dynamic Audience（例：ライン監督者）には Directory サービスから解決する。

## 7. チャネル別仕様
- **EmailAdapter**：SendGrid 互換 API。TLS、DMARC 対応。添付ファイルは 10MB 以内。
- **ChatAdapter**：Microsoft Teams / Slack Webhook。メッセージカード形式、ボタンで確認操作。
- **WebhookAdapter**：社内システム向け JSON POST。署名ヘッダで認証。
- **TTSAdapter**：IVR システム経由の音声通知。Critical 事象のみ。音声テンプレート 30 秒以内。
- **Dashboard Push**：リアルタイム通知パネルへ WebSocket 送信。既読管理を保持。

## 8. 処理フロー
1. 作業イベントサービス等が API-050 を呼び出し、通知要求を登録。
2. `NotificationGateway` がバリデーション（テンプレート存在、受信者設定、優先度）を実施。
3. `TemplateEngine` が locale / role 別テンプレートをレンダリング。
4. 通知を `notifications` テーブルに保存し、Kafka トピック `notifications.pending` へ投入。
5. Celery ワーカー `Dispatcher` がキューを消費し、チャネル別アダプタ経由で送信。
6. 成功時に `status=SENT`、失敗時に `notification_failures` へ記録し、リトライまたはエスカレーション。
7. 監査ログサービスへ送信結果を連携し、dashboard へ履歴を表示。

## 9. テンプレート管理
- テンプレートはカテゴリ＋チャネル＋言語でユニーク。
- 差込変数は JSON Schema で定義し、API で検証。
- バージョン管理：draft → active → retired。ドラフトは admin の承認後にアクティブ化。
- A/B テスト機能：テンプレートを複数用意し、一定割合で配信してクリック率を比較。

## 10. 非機能設計
- 性能：ピーク時 200 通知/秒。Kafka とワーカーを水平スケール。
- 可用性：通知要求は永続キューに保存し、Dispatcher 障害時も失われない。
- 遅延：HIGH 優先度の平均配送時間 15 秒以内。
- 観測性：OpenTelemetry でチャネル別成功率、遅延、リトライ件数を送信。

## 11. セキュリティ・プライバシー
- 受信者データは暗号化。メールアドレス・電話番号はマスキング表示。
- Webhook 送信時は HMAC-SHA256 署名を付与。受信側検証手順を提供。
- 通知内容に個人情報が含まれる場合、配信ログにはマスクされた要約のみ保存。
- RBAC：テンプレート編集は admin のみ。履歴閲覧は supervisor 以上。

## 12. 運用・監視
- ダッシュボード指標：送信件数、失敗率、チャネル別遅延、優先度別バックログ。
- アラート条件：
  - 失敗率 > 5%（5 分移動平均）
  - HIGH 優先度バックログ > 10 件
  - Dispatcher ワーカー数 < 期待値
- 運用手順：テンプレート更新レビュー、チャネル資格情報更新、バックログ解消手順。

## 13. テスト観点
- 正常送信（各チャネル）、テンプレート差込。
- 異常：テンプレート欠如、宛先不正、チャネル障害、リトライ超過。
- 優先度テスト：HIGH/LOW の SLA 満足確認。
- 受信者設定：ロール展開、Webhook 署名検証。

## 14. リスク対応
- R-002：ネットワーク障害でチャネル不達 → フェイルオーバー先チャネル（メール⇔チャット）を設定し、自動切替。
- R-003：通知過多で分析担当が飽和 → PreferenceManager でバッチ化とサマリ通知を提供。優先度別にスロット制御。
- R-004：規制変更で通知内容に制約 → テンプレートを迅速に更新できるようドラフト→承認フローと多言語サポートを整備。

---
本設計を基にチャネルアダプタ詳細、テンプレート仕様書、運用 Runbook を整備する。
