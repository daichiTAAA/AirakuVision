# 業務サービス層基本設計書

## 1. 目的
業務サービス層が提供する作業イベント管理、順序リスト管理、端末ステータス管理の設計を定義し、各 API の入出力仕様と業務ロジックを明確化する。

## 2. 適用範囲
- 作業イベント登録・照会
- 月連番および順序リスト管理
- 端末ステータス管理
- 通知連携および監査ログ

## 3. 関連要件
- 機能：F-001, F-002, F-003, F-020, F-021, F-022, F-023, F-030, F-031, F-032, F-033, F-050, F-051, F-052
- 非機能：N-003, N-007, N-008, N-009, N-014, N-018
- データ：D-001〜D-006, D-008, D-009
- インターフェース：I-001, I-002, I-004
- 運用・保守：O-001〜O-003
- リスク：R-001, R-003, R-004

## 4. サービス構成
1. **作業イベントサービス**：音声コマンドおよび手動入力から作業イベントを登録し、状態遷移を管理する。
2. **順序管理サービス**：生産指示日や工程ごとの順序リストを管理し、月連番照合を行う。
3. **端末管理サービス**：端末登録、ステータス取得、プライバシーイベント管理を提供する。
4. **通知サービス**：異常・完了・承認依頼を通知チャネルへ送信する。
5. **監査ログサービス**：重要操作と閲覧履歴を記録し、検索可能にする。

![業務サービス層システム関連図](./業務サービス層システム関連図.svg)

## 5. API 仕様
### 5.1 作業イベント API
| API ID  | メソッド | パス              | 概要             | 主要項目                                                 | 関連要件            |
| ------- | -------- | ----------------- | ---------------- | -------------------------------------------------------- | ------------------- |
| API-001 | POST     | /work-events      | 作業イベント登録 | 端末識別子、イベント種別、月連番、タイムスタンプ、信頼度 | F-020, F-022, D-003 |
| API-002 | GET      | /work-events/{id} | イベント詳細取得 | イベント ID                                              | F-020, D-003        |
| API-003 | GET      | /work-events      | イベント検索     | 期間、ライン、状態、端末識別子                           | F-033, D-003        |

### 5.2 順序管理 API
| API ID  | メソッド | パス                         | 概要               | 主要項目                               | 関連要件            |
| ------- | -------- | ---------------------------- | ------------------ | -------------------------------------- | ------------------- |
| API-010 | GET      | /production-sequences        | 順序リスト検索     | 生産指示日、工程、月連番、ステータス   | F-022, F-032, D-002 |
| API-011 | POST     | /production-sequences/import | 順序データ取り込み | アップロードファイル識別子、バージョン | F-032, I-002        |
| API-012 | PATCH    | /production-sequences/{id}   | 順序情報更新       | ステータス、優先度、備考               | F-022, D-002        |

### 5.3 端末管理 API
| API ID  | メソッド | パス                             | 概要                     | 主要項目                             | 関連要件     |
| ------- | -------- | -------------------------------- | ------------------------ | ------------------------------------ | ------------ |
| API-020 | POST     | /devices                         | 端末登録                 | 端末識別子、割当ライン、許可コマンド | F-001, D-001 |
| API-021 | GET      | /devices/{id}/status             | 端末ステータス取得       | 現在状態、期待月連番、最終イベント   | F-021, F-002 |
| API-022 | POST     | /devices/{id}/month-serial/reset | 月連番上書き             | 次回月連番、理由、承認者             | F-002, D-007 |
| API-023 | POST     | /devices/{id}/privacy-events     | プライバシーイベント登録 | 入退室種別、時刻、検知ソース         | F-003, D-003 |

### 5.4 通知 API
| API ID  | メソッド | パス                   | 概要         | 主要項目                                 | 関連要件     |
| ------- | -------- | ---------------------- | ------------ | ---------------------------------------- | ------------ |
| API-030 | POST     | /notifications         | 通知送信     | 通知種別、宛先ロール、メッセージ、優先度 | F-052, I-004 |
| API-031 | GET      | /notifications/history | 通知履歴取得 | 期間、種別、宛先                         | F-052, D-003 |

## 6. 業務ロジック
### 6.1 作業イベント処理フロー
1. 端末から API-001 が受信される。
2. 月連番と順序リストを照合し、存在しない場合は警告ステータスで登録。（F-022, D-007）
3. 同一端末のイベント順序を検証し、無効な遷移はエラーを返す。
4. 正常登録後、通知サービスへ進捗通知を送信。
5. 状態変更ログを監査ログサービスへ記録。

### 6.2 月連番管理
- 端末ごとの最新月連番を保持し、登録時に自動インクリメント。
- リセット要求（API-022）は承認ワークフローを通過し、承認・却下を記録。（N-009）

### 6.3 通知連携
- 重大アラートは即時送信し、通知履歴を保持。（O-001）
- 通知テンプレートをロール別に設定し、必要に応じて多言語化に対応する。

### 6.4 監査ログ
- 重要 API コール（登録、更新、閲覧）を全て監査ログに記録。
- 監査ログは期間で検索でき、改ざん防止のため書き換え不可領域に保存。（F-051）

## 7. データ設計
![業務サービス層ER図](./業務サービス層ER図.svg)

### 7.1 作業イベント領域
#### work_events
| 列名         | 型                       | キー種別 | 説明                                        |
| ------------ | ------------------------ | -------- | ------------------------------------------- |
| event_id     | UUID                     | PK       | 作業イベント識別子。                        |
| device_id    | UUID                     | FK       | 発生端末。`devices` を参照。                |
| sequence_id  | UUID                     | FK       | 紐付く順序。`production_sequences` を参照。 |
| month_serial | VARCHAR(12)              | -        | 月連番 (先頭ゼロ保持)。                     |
| event_type   | VARCHAR(32)              | -        | イベント種別 (CREATED 等)。                 |
| state        | VARCHAR(16)              | -        | 現在状態 (RUNNING/PAUSED/...)。             |
| occurred_at  | TIMESTAMP WITH TIME ZONE | -        | 発生時刻 (UTC)。                            |
| confidence   | NUMERIC(5,4)             | -        | 認識信頼度 (0.0〜1.0)。                     |
| source       | VARCHAR(32)              | -        | 送信元 (device/manual/import 等)。          |
| version      | BIGINT                   | -        | 楽観ロック用バージョン。                    |

#### work_event_transitions
| 列名            | 型                       | キー種別 | 説明                                 |
| --------------- | ------------------------ | -------- | ------------------------------------ |
| transition_id   | UUID                     | PK       | 状態遷移履歴の識別子。               |
| event_id        | UUID                     | FK       | 対象イベント。`work_events` を参照。 |
| from_state      | VARCHAR(16)              | -        | 遷移前ステート。                     |
| to_state        | VARCHAR(16)              | -        | 遷移後ステート。                     |
| reason_code     | VARCHAR(32)              | -        | 遷移理由コード。                     |
| transitioned_at | TIMESTAMP WITH TIME ZONE | -        | 遷移時刻。                           |
| actor           | VARCHAR(64)              | -        | 操作主体 (user/system)。             |

#### work_event_metadata
| 列名           | 型                       | キー種別 | 説明                                                |
| -------------- | ------------------------ | -------- | --------------------------------------------------- |
| event_id       | UUID                     | PK/FK    | 作業イベント識別子。`work_events` を参照。          |
| recording_id   | UUID                     | FK       | 紐付く映像。`video_recordings` を参照。             |
| sequence_id    | UUID                     | FK       | 補完順序 (NULL 可)。`production_sequences` を参照。 |
| binding_status | VARCHAR(16)              | -        | 紐付け状態 (BOUND/UNBOUND 等)。                     |
| anomaly_flag   | BOOLEAN                  | -        | 異常検知フラグ。                                    |
| linked_at      | TIMESTAMP WITH TIME ZONE | -        | 紐付け時刻。                                        |

#### event_acknowledgements
| 列名            | 型                       | キー種別 | 説明                                 |
| --------------- | ------------------------ | -------- | ------------------------------------ |
| ack_id          | UUID                     | PK       | 承認履歴識別子。                     |
| event_id        | UUID                     | FK       | 対象イベント。`work_events` を参照。 |
| ack_type        | VARCHAR(16)              | -        | 承認種別 (APPROVE/REJECT 等)。       |
| acknowledged_by | UUID                     | -        | 承認者 ID。                          |
| acknowledged_at | TIMESTAMP WITH TIME ZONE | -        | 承認時刻。                           |
| comment         | TEXT                     | -        | 承認時コメント。                     |

#### video_recordings
| 列名              | 型                       | キー種別 | 説明                              |
| ----------------- | ------------------------ | -------- | --------------------------------- |
| recording_id      | UUID                     | PK       | 録画識別子。                      |
| device_id         | UUID                     | FK       | 撮影端末。`devices` を参照。      |
| storage_path      | TEXT                     | -        | 保存パス。                        |
| captured_start_at | TIMESTAMP WITH TIME ZONE | -        | 収録開始時刻。                    |
| captured_end_at   | TIMESTAMP WITH TIME ZONE | -        | 収録終了時刻。                    |
| stream_id         | VARCHAR(64)              | -        | 連携ストリーム ID。               |
| media_status      | VARCHAR(16)              | -        | メディア状態 (READY/EXPIRED 等)。 |

### 7.2 順序管理領域
#### production_sequences
| 列名             | 型                       | キー種別 | 説明                    |
| ---------------- | ------------------------ | -------- | ----------------------- |
| sequence_id      | UUID                     | PK       | 順序識別子。            |
| instruction_date | DATE                     | -        | 生産指示日。            |
| line_id          | VARCHAR(32)              | -        | ライン ID。             |
| process_code     | VARCHAR(32)              | -        | 工程コード。            |
| product_code     | VARCHAR(64)              | -        | 製品コード。            |
| variant_code     | VARCHAR(32)              | -        | 型式／バリアント。      |
| machine_no       | VARCHAR(32)              | -        | 設備番号。              |
| month_serial     | VARCHAR(12)              | -        | 月連番。                |
| planned_start_at | TIMESTAMP WITH TIME ZONE | -        | 予定開始時刻。          |
| planned_end_at   | TIMESTAMP WITH TIME ZONE | -        | 予定終了時刻。          |
| status           | VARCHAR(16)              | -        | 順序状態 (PLANNED 等)。 |
| priority         | SMALLINT                 | -        | 優先度。                |
| remarks          | TEXT                     | -        | 備考。                  |

#### sequence_history
| 列名        | 型                       | キー種別 | 説明                                      |
| ----------- | ------------------------ | -------- | ----------------------------------------- |
| history_id  | UUID                     | PK       | 履歴識別子。                              |
| sequence_id | UUID                     | FK       | 対象順序。`production_sequences` を参照。 |
| old_status  | VARCHAR(16)              | -        | 変更前ステータス。                        |
| new_status  | VARCHAR(16)              | -        | 変更後ステータス。                        |
| changed_by  | UUID                     | -        | 操作者 ID。                               |
| changed_at  | TIMESTAMP WITH TIME ZONE | -        | 変更時刻。                                |
| comment     | TEXT                     | -        | 備考。                                    |

#### sequence_assignments
| 列名          | 型                       | キー種別 | 説明                                      |
| ------------- | ------------------------ | -------- | ----------------------------------------- |
| assignment_id | UUID                     | PK       | 割当識別子。                              |
| sequence_id   | UUID                     | FK       | 対象順序。`production_sequences` を参照。 |
| analyst_id    | UUID                     | -        | 担当アナリスト。                          |
| assigned_at   | TIMESTAMP WITH TIME ZONE | -        | 割当時刻。                                |
| due_at        | TIMESTAMP WITH TIME ZONE | -        | 対応期限。                                |

#### sequence_import_jobs
| 列名          | 型                       | キー種別 | 説明                           |
| ------------- | ------------------------ | -------- | ------------------------------ |
| job_id        | UUID                     | PK       | 取り込みジョブ識別子。         |
| source_type   | VARCHAR(16)              | -        | 入力ソース種別 (CSV/SFTP 等)。 |
| file_name     | TEXT                     | -        | 入力ファイル名。               |
| row_count     | INTEGER                  | -        | 取り込み行数。                 |
| success_count | INTEGER                  | -        | 成功件数。                     |
| failure_count | INTEGER                  | -        | 失敗件数。                     |
| status        | VARCHAR(16)              | -        | ジョブ状態。                   |
| started_at    | TIMESTAMP WITH TIME ZONE | -        | 開始時刻。                     |
| finished_at   | TIMESTAMP WITH TIME ZONE | -        | 完了時刻。                     |

#### sequence_validation_results
| 列名          | 型          | キー種別 | 説明                                        |
| ------------- | ----------- | -------- | ------------------------------------------- |
| validation_id | UUID        | PK       | 検証結果識別子。                            |
| job_id        | UUID        | FK       | 対象ジョブ。`sequence_import_jobs` を参照。 |
| row_number    | INTEGER     | -        | 行番号。                                    |
| error_code    | VARCHAR(32) | -        | エラーコード。                              |
| field         | VARCHAR(64) | -        | 対象フィールド。                            |
| message       | TEXT        | -        | 詳細メッセージ。                            |

### 7.3 端末管理領域
#### devices
| 列名             | 型                       | キー種別 | 説明                           |
| ---------------- | ------------------------ | -------- | ------------------------------ |
| device_id        | UUID                     | PK       | 端末識別子。                   |
| device_name      | VARCHAR(128)             | -        | 端末名称。                     |
| line_id          | VARCHAR(32)              | -        | 配属ライン ID。                |
| model            | VARCHAR(64)              | -        | 機種情報。                     |
| firmware_version | VARCHAR(32)              | -        | ファームウェア版。             |
| status           | VARCHAR(16)              | -        | 稼働状態 (ACTIVE/RETIRED 等)。 |
| registered_at    | TIMESTAMP WITH TIME ZONE | -        | 登録日時。                     |
| revoked_at       | TIMESTAMP WITH TIME ZONE | -        | 失効日時 (NULL 可)。           |

#### device_profiles
| 列名                   | 型                       | キー種別 | 説明                         |
| ---------------------- | ------------------------ | -------- | ---------------------------- |
| profile_id             | UUID                     | PK       | プロファイル識別子。         |
| device_id              | UUID                     | FK       | 対象端末。`devices` を参照。 |
| allowed_commands       | JSONB                    | -        | 許可コマンド集合。           |
| locales                | TEXT[]                   | -        | 対応ロケール。               |
| privacy_policy_version | VARCHAR(16)              | -        | 同意済みポリシーバージョン。 |
| updated_at             | TIMESTAMP WITH TIME ZONE | -        | 更新日時。                   |

#### device_status
| 列名                  | 型                       | キー種別 | 説明                           |
| --------------------- | ------------------------ | -------- | ------------------------------ |
| device_id             | UUID                     | PK/FK    | 端末識別子。`devices` を参照。 |
| last_seen_at          | TIMESTAMP WITH TIME ZONE | -        | 最終心拍受信時刻。             |
| network_quality       | VARCHAR(16)              | -        | ネットワーク品質。             |
| battery_level         | NUMERIC(5,2)             | -        | 残量 (%)。                     |
| temperature           | NUMERIC(5,2)             | -        | 端末温度 (摂氏)。              |
| expected_month_serial | VARCHAR(12)              | -        | 期待月連番。                   |
| privacy_state         | VARCHAR(16)              | -        | プライバシー状態。             |

#### device_month_serial_logs
| 列名            | 型                       | キー種別 | 説明                         |
| --------------- | ------------------------ | -------- | ---------------------------- |
| log_id          | UUID                     | PK       | リセット履歴識別子。         |
| device_id       | UUID                     | FK       | 対象端末。`devices` を参照。 |
| previous_serial | VARCHAR(12)              | -        | 変更前連番。                 |
| new_serial      | VARCHAR(12)              | -        | 変更後連番。                 |
| reason          | TEXT                     | -        | 申請理由。                   |
| requested_by    | UUID                     | -        | 申請者 ID。                  |
| approved_by     | UUID                     | -        | 承認者 ID。                  |
| updated_at      | TIMESTAMP WITH TIME ZONE | -        | 処理日時。                   |

#### device_certificates
| 列名       | 型                       | キー種別 | 説明                         |
| ---------- | ------------------------ | -------- | ---------------------------- |
| cert_id    | UUID                     | PK       | 証明書識別子。               |
| device_id  | UUID                     | FK       | 対象端末。`devices` を参照。 |
| thumbprint | VARCHAR(128)             | -        | 証明書フィンガープリント。   |
| valid_from | TIMESTAMP WITH TIME ZONE | -        | 有効開始。                   |
| valid_to   | TIMESTAMP WITH TIME ZONE | -        | 有効終了。                   |
| status     | VARCHAR(16)              | -        | 状態 (ACTIVE/REVOKED 等)。   |

#### privacy_events
| 列名        | 型                       | キー種別 | 説明                         |
| ----------- | ------------------------ | -------- | ---------------------------- |
| event_id    | UUID                     | PK       | プライバシーイベント識別子。 |
| device_id   | UUID                     | FK       | 発生端末。`devices` を参照。 |
| zone_id     | VARCHAR(64)              | -        | ゾーン識別子。               |
| event_type  | VARCHAR(16)              | -        | 入退室種別等。               |
| detected_at | TIMESTAMP WITH TIME ZONE | -        | 検知時刻。                   |
| source      | VARCHAR(32)              | -        | 検知ソース。                 |
| handled_by  | VARCHAR(64)              | -        | 対応主体。                   |

### 7.4 通知領域
#### notifications
| 列名            | 型                       | キー種別 | 説明                    |
| --------------- | ------------------------ | -------- | ----------------------- |
| notification_id | UUID                     | PK       | 通知要求識別子。        |
| request_id      | UUID                     | -        | リクエストトレース ID。 |
| category        | VARCHAR(32)              | -        | 通知カテゴリ。          |
| priority        | VARCHAR(16)              | -        | 優先度。                |
| status          | VARCHAR(16)              | -        | 配信状態。              |
| channel_set     | JSONB                    | -        | 使用チャネル集合。      |
| payload         | JSONB                    | -        | 送信本文。              |
| created_at      | TIMESTAMP WITH TIME ZONE | -        | 登録時刻。              |
| sent_at         | TIMESTAMP WITH TIME ZONE | -        | 送信完了時刻。          |

#### notification_templates
| 列名        | 型          | キー種別 | 説明                 |
| ----------- | ----------- | -------- | -------------------- |
| template_id | UUID        | PK       | テンプレート識別子。 |
| category    | VARCHAR(32) | -        | 対応カテゴリ。       |
| locale      | VARCHAR(8)  | -        | 言語。               |
| channel     | VARCHAR(16) | -        | チャネル種別。       |
| version     | INTEGER     | -        | バージョン。         |
| subject     | TEXT        | -        | 件名／タイトル。     |
| body        | TEXT        | -        | 本文。               |
| variables   | JSONB       | -        | 差込変数定義。       |

#### notification_channels
| 列名        | 型          | キー種別 | 説明                           |
| ----------- | ----------- | -------- | ------------------------------ |
| channel_id  | UUID        | PK       | チャネル設定識別子。           |
| type        | VARCHAR(16) | -        | チャネル種別 (email/chat 等)。 |
| endpoint    | TEXT        | -        | 宛先エンドポイント。           |
| auth_config | JSONB       | -        | 認証設定。                     |

#### notification_preferences
| 列名            | 型                       | キー種別 | 説明                         |
| --------------- | ------------------------ | -------- | ---------------------------- |
| preference_id   | UUID                     | PK       | 通知設定識別子。             |
| user_or_role    | VARCHAR(64)              | -        | 宛先ユーザまたはロール。     |
| category        | VARCHAR(32)              | -        | 対象カテゴリ。               |
| channel         | VARCHAR(16)              | -        | 希望チャネル。               |
| delivery_window | JSONB                    | -        | 配信許可時間帯 (JSON 定義)。 |
| mute_until      | TIMESTAMP WITH TIME ZONE | -        | サイレンス期限。             |

#### notification_failures
| 列名            | 型                       | キー種別 | 説明                               |
| --------------- | ------------------------ | -------- | ---------------------------------- |
| failure_id      | UUID                     | PK       | 失敗レコード識別子。               |
| notification_id | UUID                     | FK       | 対象通知。`notifications` を参照。 |
| attempt         | SMALLINT                 | -        | リトライ回数。                     |
| channel         | VARCHAR(16)              | -        | 送信チャネル。                     |
| error_code      | VARCHAR(32)              | -        | エラーコード。                     |
| error_message   | TEXT                     | -        | エラーメッセージ。                 |
| occurred_at     | TIMESTAMP WITH TIME ZONE | -        | 発生時刻。                         |

#### notification_audit
| 列名            | 型                       | キー種別 | 説明                               |
| --------------- | ------------------------ | -------- | ---------------------------------- |
| audit_id        | UUID                     | PK       | 通知履歴識別子。                   |
| notification_id | UUID                     | FK       | 対象通知。`notifications` を参照。 |
| actor           | VARCHAR(64)              | -        | 操作者。                           |
| action          | VARCHAR(32)              | -        | 操作種別。                         |
| timestamp       | TIMESTAMP WITH TIME ZONE | -        | 操作時刻。                         |
| details         | JSONB                    | -        | 付帯情報。                         |

### 7.5 監査領域
#### audit_logs
| 列名             | 型                       | キー種別 | 説明                               |
| ---------------- | ------------------------ | -------- | ---------------------------------- |
| audit_id         | UUID                     | PK       | 監査ログ識別子。                   |
| timestamp        | TIMESTAMP WITH TIME ZONE | -        | 操作発生時刻 (UTC)。               |
| actor_type       | VARCHAR(16)              | -        | 操作者種別 (user/device/system)。  |
| actor_id         | VARCHAR(64)              | -        | 操作者 ID。                        |
| actor_role       | VARCHAR(32)              | -        | 操作者ロール。                     |
| action           | VARCHAR(64)              | -        | 操作名。                           |
| target_type      | VARCHAR(32)              | -        | 対象種別。                         |
| target_id        | VARCHAR(64)              | -        | 対象 ID。                          |
| request_id       | UUID                     | -        | リクエスト識別子。                 |
| source_ip        | INET                     | -        | 発信元 IP。                        |
| result           | VARCHAR(16)              | -        | 結果 (success 等)。                |
| detail           | JSONB                    | -        | 付帯情報 JSON。                    |
| hash             | VARCHAR(128)             | -        | レコードハッシュ (SHA-512)。       |
| chain_hash       | VARCHAR(128)             | -        | 直前レコードとのチェーンハッシュ。 |
| integrity_status | VARCHAR(16)              | -        | 改ざん検知状態。                   |
| pii_flag         | BOOLEAN                  | -        | 個人情報フラグ。                   |
| sensitivity      | VARCHAR(16)              | -        | 機密度区分。                       |

## 8. 非機能設計
- 応答性能：API-001〜003 の平均応答時間 1 秒以内。（N-003）
- 可用性：冗長化構成でシステム停止無しでメンテナンス実施。（N-004, N-014）
- セキュリティ：多要素認証を必須とし、API 呼び出しにアクセストークンを要求。（N-007, N-008）
- 拡張性：API バージョニングを導入し、新機能追加時も既存クライアント影響を最小化。（N-018）

## 9. 運用・保守
- バッチ：順序リスト取り込みはスケジュールバッチと手動アップロードを併用し、結果は通知する。（I-002）
- 監視：API エラー率、遅延、リトライ回数を監視し、閾値超過で運用チームへ通知。（O-001）
- バージョン管理：API の変更は変更審査を経て、ドキュメントとモックを更新する。（O-002, O-003）

## 10. リスク対応
- R-001：音声認識低下時、手動登録画面を用意し、業務サービス層で端末イベントとの整合性を保持。
- R-003：ラベリング負荷異常時は作業イベントの優先度を調整し、作業者割当を通知。
- R-004：法規制変更時に監査ログ保持期間やアクセス権限を設定可能とする。

---
本設計書の内容を基に詳細定義およびテスト仕様を整備する。
