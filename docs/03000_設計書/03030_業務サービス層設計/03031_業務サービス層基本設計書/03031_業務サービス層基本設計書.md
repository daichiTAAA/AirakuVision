# 業務サービス層基本設計書

# 1. 目的
業務サービス層が提供する作業イベント管理、順序リスト管理、端末ステータス管理の設計を定義し、共通の業務ロジックおよびデータ・非機能要件を明確化する。

# 2. 関連要件
- 機能：F-001, F-002, F-003, F-020, F-021, F-022, F-023, F-030, F-031, F-032, F-033, F-050, F-051, F-052
- 非機能：N-003, N-007, N-008, N-009, N-014, N-018
- データ：D-001〜D-006, D-008, D-009
- インターフェース：I-001, I-002, I-004
- 運用・保守：O-001〜O-003
- リスク：R-001, R-003, R-004

# 3. サービス構成
1. **作業イベントサービス**：音声コマンドおよび手動入力から作業イベントを登録し、状態遷移を管理する。
2. **順序管理サービス**：生産指示日や工程ごとの順序リストを管理し、月連番照合を行う。
3. **端末管理サービス**：端末登録、ステータス取得、プライバシーイベント管理を提供する。
4. **通知サービス**：異常・完了・承認依頼を通知チャネルへ送信する。
5. **監査ログサービス**：重要操作と閲覧履歴を記録し、検索可能にする。

![業務サービス層システム関連図](./業務サービス層システム関連図.svg)

# 4. データ設計
![業務サービス層ER図](./業務サービス層ER図.svg)

* suffix
  * _f: ファクトテーブル（履歴・ログ）
  * _m: マスタテーブル（参照データ）

* 各テーブルにおける必須列
  * created_at (TIMESTAMP WITH TIME ZONE): レコード作成日時 (UTC)
  * created_by (UUID): 作成者 ID (システム操作は 'system')
  * updated_at (TIMESTAMP WITH TIME ZONE): 最終更新日時 (UTC)
  * updated_by (UUID): 最終更新者 ID

## 4.1. 作業イベント領域
### 4.1.1. work_events_f
| 列名         | 型                       | キー種別 | 説明                                          |
| ------------ | ------------------------ | -------- | --------------------------------------------- |
| event_id     | UUID                     | PK       | 作業イベント識別子。                          |
| device_id    | UUID                     | FK       | 発生端末。`devices_m` を参照。                |
| sequence_id  | UUID                     | FK       | 紐付く順序。`production_sequences_f` を参照。 |
| month_serial | VARCHAR(12)              | -        | 月連番 (先頭ゼロ保持)。                       |
| event_type   | VARCHAR(32)              | -        | イベント種別 (CREATED 等)。                   |
| state        | VARCHAR(16)              | -        | 現在状態 (RUNNING/PAUSED/...)。               |
| occurred_at  | TIMESTAMP WITH TIME ZONE | -        | 発生時刻 (UTC)。                              |
| confidence   | NUMERIC(5,4)             | -        | 認識信頼度 (0.0〜1.0)。                       |
| source       | VARCHAR(32)              | -        | 送信元 (device/manual/import 等)。            |
| version      | BIGINT                   | -        | 楽観ロック用バージョン。                      |

### 4.1.2. work_event_transitions_f
| 列名            | 型                       | キー種別 | 説明                                 |
| --------------- | ------------------------ | -------- | ------------------------------------ |
| transition_id   | UUID                     | PK       | 状態遷移履歴の識別子。               |
| event_id        | UUID                     | FK       | 対象イベント。`work_events` を参照。 |
| from_state      | VARCHAR(16)              | -        | 遷移前ステート。                     |
| to_state        | VARCHAR(16)              | -        | 遷移後ステート。                     |
| reason_code     | VARCHAR(32)              | -        | 遷移理由コード。                     |
| transitioned_at | TIMESTAMP WITH TIME ZONE | -        | 遷移時刻。                           |
| actor           | VARCHAR(64)              | -        | 操作主体 (user/system)。             |

### 4.1.3. work_event_metadata_f
| 列名           | 型                       | キー種別 | 説明                                                  |
| -------------- | ------------------------ | -------- | ----------------------------------------------------- |
| event_id       | UUID                     | PK/FK    | 作業イベント識別子。`work_events` を参照。            |
| recording_id   | UUID                     | FK       | 紐付く映像。`video_recordings` を参照。               |
| sequence_id    | UUID                     | FK       | 補完順序 (NULL 可)。`production_sequences_f` を参照。 |
| binding_status | VARCHAR(16)              | -        | 紐付け状態 (BOUND/UNBOUND 等)。                       |
| anomaly_flag   | BOOLEAN                  | -        | 異常検知フラグ。                                      |
| linked_at      | TIMESTAMP WITH TIME ZONE | -        | 紐付け時刻。                                          |

### 4.1.4. event_acknowledgements_f
| 列名            | 型                       | キー種別 | 説明                                 |
| --------------- | ------------------------ | -------- | ------------------------------------ |
| ack_id          | UUID                     | PK       | 承認履歴識別子。                     |
| event_id        | UUID                     | FK       | 対象イベント。`work_events` を参照。 |
| ack_type        | VARCHAR(16)              | -        | 承認種別 (APPROVE/REJECT 等)。       |
| acknowledged_by | UUID                     | -        | 承認者 ID。                          |
| acknowledged_at | TIMESTAMP WITH TIME ZONE | -        | 承認時刻。                           |
| comment         | TEXT                     | -        | 承認時コメント。                     |

### 4.1.5. video_recordings_f
| 列名              | 型                       | キー種別 | 説明                              |
| ----------------- | ------------------------ | -------- | --------------------------------- |
| recording_id      | UUID                     | PK       | 録画識別子。                      |
| device_id         | UUID                     | FK       | 撮影端末。`devices_m` を参照。    |
| storage_path      | TEXT                     | -        | 保存パス。                        |
| captured_start_at | TIMESTAMP WITH TIME ZONE | -        | 収録開始時刻。                    |
| captured_end_at   | TIMESTAMP WITH TIME ZONE | -        | 収録終了時刻。                    |
| stream_id         | VARCHAR(64)              | -        | 連携ストリーム ID。               |
| media_status      | VARCHAR(16)              | -        | メディア状態 (READY/EXPIRED 等)。 |

## 4.2. 順序管理領域
### 4.2.1. production_sequences_f
| 列名             | 型          | キー種別 | 説明                    |
| ---------------- | ----------- | -------- | ----------------------- |
| sequence_id      | UUID        | PK       | 順序識別子。            |
| instruction_date | DATE        | -        | 生産指示日。            |
| process_code     | VARCHAR(32) | -        | 工程コード。            |
| product_code     | VARCHAR(64) | -        | 製品コード。            |
| variant_code     | VARCHAR(32) | -        | 型式／バリアント。      |
| machine_no       | VARCHAR(32) | -        | 設備番号。              |
| month_serial     | VARCHAR(12) | -        | 月連番。                |
| status           | VARCHAR(16) | -        | 順序状態 (PLANNED 等)。 |
| priority         | SMALLINT    | -        | 優先度。                |
| remarks          | TEXT        | -        | 備考。                  |

### 4.2.3. sequence_history_f
| 列名        | 型                       | キー種別 | 説明                                        |
| ----------- | ------------------------ | -------- | ------------------------------------------- |
| history_id  | UUID                     | PK       | 履歴識別子。                                |
| sequence_id | UUID                     | FK       | 対象順序。`production_sequences_f` を参照。 |
| old_status  | VARCHAR(16)              | -        | 変更前ステータス。                          |
| new_status  | VARCHAR(16)              | -        | 変更後ステータス。                          |
| changed_by  | UUID                     | -        | 操作者 ID。                                 |
| changed_at  | TIMESTAMP WITH TIME ZONE | -        | 変更時刻。                                  |
| comment     | TEXT                     | -        | 備考。                                      |

### 4.2.4. sequence_assignments_f
| 列名          | 型                       | キー種別 | 説明                                        |
| ------------- | ------------------------ | -------- | ------------------------------------------- |
| assignment_id | UUID                     | PK       | 割当識別子。                                |
| sequence_id   | UUID                     | FK       | 対象順序。`production_sequences_f` を参照。 |
| analyst_id    | UUID                     | -        | 担当アナリスト。                            |
| assigned_at   | TIMESTAMP WITH TIME ZONE | -        | 割当時刻。                                  |
| due_at        | TIMESTAMP WITH TIME ZONE | -        | 対応期限。                                  |

### 4.2.5. sequence_import_jobs_f
| 列名          | 型                       | キー種別 | 説明                           |
| ------------- | ------------------------ | -------- | ------------------------------ |
| job_id        | UUID                     | PK       | 取り込みジョブ識別子。         |
| source_type   | VARCHAR(16)              | -        | 入力ソース種別 (CSV/SFTP 等)。 |
| file_name     | TEXT                     | -        | 入力ファイル名。               |
| row_count     | INTEGER                  | -        | 取り込み行数。                 |
| success_count | INTEGER                  | -        | 成功件数。                     |
| failure_count | INTEGER                  | -        | 失敗件数。                     |
| status        | VARCHAR(16)              | -        | ジョブ状態。                   |
| started_at    | TIMESTAMP WITH TIME ZONE | -        | 開始時刻。                     |
| finished_at   | TIMESTAMP WITH TIME ZONE | -        | 完了時刻。                     |

### 4.2.6. sequence_validation_results_f
| 列名          | 型          | キー種別 | 説明                                        |
| ------------- | ----------- | -------- | ------------------------------------------- |
| validation_id | UUID        | PK       | 検証結果識別子。                            |
| job_id        | UUID        | FK       | 対象ジョブ。`sequence_import_jobs` を参照。 |
| row_number    | INTEGER     | -        | 行番号。                                    |
| error_code    | VARCHAR(32) | -        | エラーコード。                              |
| field         | VARCHAR(64) | -        | 対象フィールド。                            |
| message       | TEXT        | -        | 詳細メッセージ。                            |

### 4.2.8. products_m
| 列名         | 型           | キー種別 | 説明         |
| ------------ | ------------ | -------- | ------------ |
| product_code | VARCHAR(64)  | PK       | 製品コード。 |
| product_name | VARCHAR(128) | -        | 製品名称。   |
| description  | TEXT         | -        | 製品説明。   |


## 4.3. 端末管理領域
### 4.3.1. devices_m
| 列名             | 型                       | キー種別 | 説明                               |
| ---------------- | ------------------------ | -------- | ---------------------------------- |
| device_id        | UUID                     | PK       | 端末識別子。                       |
| device_name      | VARCHAR(128)             | -        | 端末名称。                         |
| process_code     | VARCHAR(32)              | FK       | 紐付く工程。`processes_m` を参照。 |
| model            | VARCHAR(64)              | -        | 機種情報。                         |
| firmware_version | VARCHAR(32)              | -        | ファームウェア版。                 |
| status           | VARCHAR(16)              | -        | 稼働状態 (ACTIVE/RETIRED 等)。     |
| registered_at    | TIMESTAMP WITH TIME ZONE | -        | 登録日時。                         |
| revoked_at       | TIMESTAMP WITH TIME ZONE | -        | 失効日時 (NULL 可)。               |

### 4.3.2. device_profiles_m
| 列名                   | 型          | キー種別 | 説明                           |
| ---------------------- | ----------- | -------- | ------------------------------ |
| profile_id             | UUID        | PK       | プロファイル識別子。           |
| device_id              | UUID        | FK       | 対象端末。`devices_m` を参照。 |
| allowed_commands       | JSONB       | -        | 許可コマンド集合。             |
| locales                | TEXT[]      | -        | 対応ロケール。                 |
| privacy_policy_version | VARCHAR(16) | -        | 同意済みポリシーバージョン。   |

### 4.3.3. device_status_f
| 列名                  | 型                       | キー種別 | 説明                             |
| --------------------- | ------------------------ | -------- | -------------------------------- |
| device_id             | UUID                     | PK/FK    | 端末識別子。`devices_m` を参照。 |
| last_seen_at          | TIMESTAMP WITH TIME ZONE | -        | 最終心拍受信時刻。               |
| network_quality       | VARCHAR(16)              | -        | ネットワーク品質。               |
| battery_level         | NUMERIC(5,2)             | -        | 残量 (%)。                       |
| temperature           | NUMERIC(5,2)             | -        | 端末温度 (摂氏)。                |
| expected_month_serial | VARCHAR(12)              | -        | 期待月連番。                     |
| privacy_state         | VARCHAR(16)              | -        | プライバシー状態。               |

### 4.3.4. device_month_serial_logs_f
| 列名            | 型          | キー種別 | 説明                           |
| --------------- | ----------- | -------- | ------------------------------ |
| log_id          | UUID        | PK       | リセット履歴識別子。           |
| device_id       | UUID        | FK       | 対象端末。`devices_m` を参照。 |
| previous_serial | VARCHAR(12) | -        | 変更前連番。                   |
| new_serial      | VARCHAR(12) | -        | 変更後連番。                   |
| reason          | TEXT        | -        | 申請理由。                     |
| requested_by    | UUID        | -        | 申請者 ID。                    |
| approved_by     | UUID        | -        | 承認者 ID。                    |

### 4.3.5. device_certificates_f
| 列名       | 型                       | キー種別 | 説明                           |
| ---------- | ------------------------ | -------- | ------------------------------ |
| cert_id    | UUID                     | PK       | 証明書識別子。                 |
| device_id  | UUID                     | FK       | 対象端末。`devices_m` を参照。 |
| thumbprint | VARCHAR(128)             | -        | 証明書フィンガープリント。     |
| valid_from | TIMESTAMP WITH TIME ZONE | -        | 有効開始。                     |
| valid_to   | TIMESTAMP WITH TIME ZONE | -        | 有効終了。                     |
| status     | VARCHAR(16)              | -        | 状態 (ACTIVE/REVOKED 等)。     |

### 4.3.6. privacy_events_f
| 列名        | 型                       | キー種別 | 説明                           |
| ----------- | ------------------------ | -------- | ------------------------------ |
| event_id    | UUID                     | PK       | プライバシーイベント識別子。   |
| device_id   | UUID                     | FK       | 発生端末。`devices_m` を参照。 |
| zone_id     | VARCHAR(64)              | -        | ゾーン識別子。                 |
| event_type  | VARCHAR(16)              | -        | 入退室種別等。                 |
| detected_at | TIMESTAMP WITH TIME ZONE | -        | 検知時刻。                     |
| source      | VARCHAR(32)              | -        | 検知ソース。                   |
| handled_by  | VARCHAR(64)              | -        | 対応主体。                     |

### 4.3.7. processes_m
| 列名         | 型           | キー種別 | 説明                      |
| ------------ | ------------ | -------- | ------------------------- |
| process_code | VARCHAR(32)  | PK       | 工程コード。              |
| process_name | VARCHAR(128) | -        | 工程名称。                |
| line_id      | VARCHAR(32)  | -        | 所属ライン ID (NULL 可)。 |
| description  | TEXT         | -        | 補足説明。                |
| is_active    | BOOLEAN      | -        | 利用可否フラグ。          |

### 4.3.8. lines_m
| 列名        | 型           | キー種別 | 説明             |
| ----------- | ------------ | -------- | ---------------- |
| line_id     | VARCHAR(32)  | PK       | ライン ID。      |
| line_name   | VARCHAR(128) | -        | ライン名称。     |
| description | TEXT         | -        | 補足説明。       |
| is_active   | BOOLEAN      | -        | 利用可否フラグ。 |

## 4.4. 通知領域
### 4.4.1. notifications_f
| 列名            | 型                       | キー種別 | 説明                    |
| --------------- | ------------------------ | -------- | ----------------------- |
| notification_id | UUID                     | PK       | 通知要求識別子。        |
| request_id      | UUID                     | -        | リクエストトレース ID。 |
| category        | VARCHAR(32)              | -        | 通知カテゴリ。          |
| priority        | VARCHAR(16)              | -        | 優先度。                |
| status          | VARCHAR(16)              | -        | 配信状態。              |
| channel_set     | JSONB                    | -        | 使用チャネル集合。      |
| payload         | JSONB                    | -        | 送信本文。              |
| sent_at         | TIMESTAMP WITH TIME ZONE | -        | 送信完了時刻。          |

### 4.4.2. notification_templates_f
| 列名        | 型          | キー種別 | 説明                 |
| ----------- | ----------- | -------- | -------------------- |
| template_id | UUID        | PK       | テンプレート識別子。 |
| category    | VARCHAR(32) | -        | 対応カテゴリ。       |
| locale      | VARCHAR(8)  | -        | 言語。               |
| channel     | VARCHAR(16) | -        | チャネル種別。       |
| version     | INTEGER     | -        | バージョン。         |
| subject     | TEXT        | -        | 件名／タイトル。     |
| body        | TEXT        | -        | 本文。               |
| variables   | JSONB       | -        | 差込変数定義。       |

### 4.4.3. notification_channels_f
| 列名        | 型          | キー種別 | 説明                           |
| ----------- | ----------- | -------- | ------------------------------ |
| channel_id  | UUID        | PK       | チャネル設定識別子。           |
| type        | VARCHAR(16) | -        | チャネル種別 (email/chat 等)。 |
| endpoint    | TEXT        | -        | 宛先エンドポイント。           |
| auth_config | JSONB       | -        | 認証設定。                     |

### 4.4.4. notification_preferences_f
| 列名            | 型                       | キー種別 | 説明                         |
| --------------- | ------------------------ | -------- | ---------------------------- |
| preference_id   | UUID                     | PK       | 通知設定識別子。             |
| user_or_role    | VARCHAR(64)              | -        | 宛先ユーザまたはロール。     |
| category        | VARCHAR(32)              | -        | 対象カテゴリ。               |
| channel         | VARCHAR(16)              | -        | 希望チャネル。               |
| delivery_window | JSONB                    | -        | 配信許可時間帯 (JSON 定義)。 |
| mute_until      | TIMESTAMP WITH TIME ZONE | -        | サイレンス期限。             |

### 4.4.5. notification_failures_f
| 列名            | 型                       | キー種別 | 説明                               |
| --------------- | ------------------------ | -------- | ---------------------------------- |
| failure_id      | UUID                     | PK       | 失敗レコード識別子。               |
| notification_id | UUID                     | FK       | 対象通知。`notifications` を参照。 |
| attempt         | SMALLINT                 | -        | リトライ回数。                     |
| channel         | VARCHAR(16)              | -        | 送信チャネル。                     |
| error_code      | VARCHAR(32)              | -        | エラーコード。                     |
| error_message   | TEXT                     | -        | エラーメッセージ。                 |
| occurred_at     | TIMESTAMP WITH TIME ZONE | -        | 発生時刻。                         |

### 4.4.6. notification_audit_f
| 列名            | 型                       | キー種別 | 説明                               |
| --------------- | ------------------------ | -------- | ---------------------------------- |
| audit_id        | UUID                     | PK       | 通知履歴識別子。                   |
| notification_id | UUID                     | FK       | 対象通知。`notifications` を参照。 |
| actor           | VARCHAR(64)              | -        | 操作者。                           |
| action          | VARCHAR(32)              | -        | 操作種別。                         |
| timestamp       | TIMESTAMP WITH TIME ZONE | -        | 操作時刻。                         |
| details         | JSONB                    | -        | 付帯情報。                         |

## 4.5. 監査領域
### 4.5.1. audit_logs_f
| 列名             | 型                       | キー種別 | 説明                               |
| ---------------- | ------------------------ | -------- | ---------------------------------- |
| audit_id         | UUID                     | PK       | 監査ログ識別子。                   |
| timestamp        | TIMESTAMP WITH TIME ZONE | -        | 操作発生時刻 (UTC)。               |
| actor_type       | VARCHAR(16)              | -        | 操作者種別 (user/device/system)。  |
| actor_id         | VARCHAR(64)              | -        | 操作者 ID。                        |
| actor_role       | VARCHAR(32)              | -        | 操作者ロール。                     |
| action           | VARCHAR(64)              | -        | 操作名。                           |
| target_type      | VARCHAR(32)              | -        | 対象種別。                         |
| target_id        | VARCHAR(64)              | -        | 対象 ID。                          |
| request_id       | UUID                     | -        | リクエスト識別子。                 |
| source_ip        | INET                     | -        | 発信元 IP。                        |
| result           | VARCHAR(16)              | -        | 結果 (success 等)。                |
| detail           | JSONB                    | -        | 付帯情報 JSON。                    |
| hash             | VARCHAR(128)             | -        | レコードハッシュ (SHA-512)。       |
| chain_hash       | VARCHAR(128)             | -        | 直前レコードとのチェーンハッシュ。 |
| integrity_status | VARCHAR(16)              | -        | 改ざん検知状態。                   |
| pii_flag         | BOOLEAN                  | -        | 個人情報フラグ。                   |
| sensitivity      | VARCHAR(16)              | -        | 機密度区分。                       |

# 5. 非機能設計
- 応答性能：API-001〜003 の平均応答時間 1 秒以内。（N-003）
- 可用性：冗長化構成でシステム停止無しでメンテナンス実施。（N-004, N-014）
- セキュリティ：多要素認証を必須とし、API 呼び出しにアクセストークンを要求。（N-007, N-008）
- 拡張性：API バージョニングを導入し、新機能追加時も既存クライアント影響を最小化。（N-018）

## 5.1. オブザーバビリティ（OpenTelemetry）
- **収集方式**：業務サービスの API ゲートウェイ、アプリケーションサーバ、バックグラウンドワーカーを OpenTelemetry SDK で計装し、OTLP/gRPC でローカル OpenTelemetry Collector（DaemonSet）へ送信する。Collector は 03060_運用監視層設計で定義された `telemetry-metrics`／`telemetry-traces`／`telemetry-logs` トピックへ Kafka エクスポートする。
- **メトリクス**：HTTP/gRPC リクエストレイテンシ（P50/P90/P99）、エラー率、同時リクエスト数、DB 接続プール利用率、Kafka 出力キュー長、バッチ処理の成功・失敗件数を `service.name=business-services` の名前空間で送信する。閾値は 03060 に従い Alertmanager へ連携する。
- **トレース**：W3C Trace Context を全 API/内部呼び出しに伝播し、順序管理・通知・監査ログとの連携チェーンを可視化する。エラーまたは P95 超過時は Collector のテールベースサンプリングをトリガーし、スパンを必ず保持する。
- **ログ**：構造化 JSON ログを OpenTelemetry ログエクスポーター経由で Collector へ転送し、PII はアプリケーション側でマスキングする。監査ログに紐付く `request_id`／`trace_id` をログに出力し、Jaeger から参照できるようにする。
- **設定管理**：`OTEL_SERVICE_NAME`、`OTEL_EXPORTER_OTLP_ENDPOINT` などの環境変数を Kubernetes ConfigMap で一元管理し、サービス再起動なしでサンプリング率を変更できるよう Feature Flag（LaunchDarkly 想定）を組み込む。
- **検証**：CI/CD パイプラインで OpenTelemetry Collector モックへの送信を自動テストし、メトリクス名・ラベルのスキーマ逸脱を検出する。パフォーマンステストでは Collector 経由で 03060 の取り込み上限（100k metrics/s, 10k spans/s）に達しないことを確認する。

# 6. 運用・保守
- バッチ：順序リスト取り込みはスケジュールバッチと手動アップロードを併用し、結果は通知する。（I-002）
- 監視：API エラー率、遅延、リトライ回数を監視し、閾値超過で運用チームへ通知。（O-001）
- テレメトリ運用：Collector 経由で送信されたメトリクス／トレース／ログを Grafana・Jaeger で日次確認し、`telemetry-*` トピックのラグや取り込み失敗は運用監視層の Runbook（03060）に従って対処する。
- バージョン管理：API の変更は変更審査を経て、ドキュメントとモックを更新する。（O-002, O-003）

# 7. リスク対応
- R-001：音声認識低下時、手動登録画面を用意し、業務サービス層で端末イベントとの整合性を保持。
- R-003：ラベリング負荷異常時は作業イベントの優先度を調整し、作業者割当を通知。
- R-004：法規制変更時に監査ログ保持期間やアクセス権限を設定可能とする。

---
本設計書の内容を基に詳細定義およびテスト仕様を整備する。
