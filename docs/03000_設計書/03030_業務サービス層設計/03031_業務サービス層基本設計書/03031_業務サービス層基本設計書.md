# 業務サービス層基本設計書

## 1. 目的
業務サービス層が提供する作業イベント管理、順序リスト管理、端末ステータス管理の設計を定義し、各 API の入出力仕様と業務ロジックを明確化する。

## 2. 適用範囲
- 作業イベント登録・照会
- 月連番および順序リスト管理
- 端末ステータス管理
- 通知連携および監査ログ

## 3. 関連要件
- 機能：F-001, F-002, F-003, F-020, F-021, F-022, F-023, F-030, F-031, F-032, F-033, F-050, F-051, F-052
- 非機能：N-003, N-007, N-008, N-009, N-014, N-018
- データ：D-001〜D-006, D-008, D-009
- インターフェース：I-001, I-002, I-004
- 運用・保守：O-001〜O-003
- リスク：R-001, R-003, R-004

## 4. サービス構成
1. **作業イベントサービス**：音声コマンドおよび手動入力から作業イベントを登録し、状態遷移を管理する。
2. **順序管理サービス**：生産指示日や工程ごとの順序リストを管理し、月連番照合を行う。
3. **端末管理サービス**：端末登録、ステータス取得、プライバシーイベント管理を提供する。
4. **通知サービス**：異常・完了・承認依頼を通知チャネルへ送信する。
5. **監査ログサービス**：重要操作と閲覧履歴を記録し、検索可能にする。

![業務サービス層システム関連図](./業務サービス層システム関連図.svg)

## 5. API 仕様
### 5.1 作業イベント API
| API ID  | メソッド | パス              | 概要             | 主要項目                                                 | 関連要件            |
| ------- | -------- | ----------------- | ---------------- | -------------------------------------------------------- | ------------------- |
| API-001 | POST     | /work-events      | 作業イベント登録 | 端末識別子、イベント種別、月連番、タイムスタンプ、信頼度 | F-020, F-022, D-003 |
| API-002 | GET      | /work-events/{id} | イベント詳細取得 | イベント ID                                              | F-020, D-003        |
| API-003 | GET      | /work-events      | イベント検索     | 期間、ライン、状態、端末識別子                           | F-033, D-003        |

### 5.2 順序管理 API
| API ID  | メソッド | パス                         | 概要               | 主要項目                               | 関連要件            |
| ------- | -------- | ---------------------------- | ------------------ | -------------------------------------- | ------------------- |
| API-010 | GET      | /production-sequences        | 順序リスト検索     | 生産指示日、工程、月連番、ステータス   | F-022, F-032, D-002 |
| API-011 | POST     | /production-sequences/import | 順序データ取り込み | アップロードファイル識別子、バージョン | F-032, I-002        |
| API-012 | PATCH    | /production-sequences/{id}   | 順序情報更新       | ステータス、優先度、備考               | F-022, D-002        |

### 5.3 端末管理 API
| API ID  | メソッド | パス                             | 概要                     | 主要項目                             | 関連要件     |
| ------- | -------- | -------------------------------- | ------------------------ | ------------------------------------ | ------------ |
| API-020 | POST     | /devices                         | 端末登録                 | 端末識別子、割当ライン、許可コマンド | F-001, D-001 |
| API-021 | GET      | /devices/{id}/status             | 端末ステータス取得       | 現在状態、期待月連番、最終イベント   | F-021, F-002 |
| API-022 | POST     | /devices/{id}/month-serial/reset | 月連番上書き             | 次回月連番、理由、承認者             | F-002, D-007 |
| API-023 | POST     | /devices/{id}/privacy-events     | プライバシーイベント登録 | 入退室種別、時刻、検知ソース         | F-003, D-003 |

### 5.4 通知 API
| API ID  | メソッド | パス                   | 概要         | 主要項目                                 | 関連要件     |
| ------- | -------- | ---------------------- | ------------ | ---------------------------------------- | ------------ |
| API-030 | POST     | /notifications         | 通知送信     | 通知種別、宛先ロール、メッセージ、優先度 | F-052, I-004 |
| API-031 | GET      | /notifications/history | 通知履歴取得 | 期間、種別、宛先                         | F-052, D-003 |

## 6. 業務ロジック
### 6.1 作業イベント処理フロー
1. 端末から API-001 が受信される。
2. 月連番と順序リストを照合し、存在しない場合は警告ステータスで登録。（F-022, D-007）
3. 同一端末のイベント順序を検証し、無効な遷移はエラーを返す。
4. 正常登録後、通知サービスへ進捗通知を送信。
5. 状態変更ログを監査ログサービスへ記録。

### 6.2 月連番管理
- 端末ごとの最新月連番を保持し、登録時に自動インクリメント。
- リセット要求（API-022）は承認ワークフローを通過し、承認・却下を記録。（N-009）

### 6.3 通知連携
- 重大アラートは即時送信し、通知履歴を保持。（O-001）
- 通知テンプレートをロール別に設定し、必要に応じて多言語化に対応する。

### 6.4 監査ログ
- 重要 API コール（登録、更新、閲覧）を全て監査ログに記録。
- 監査ログは期間で検索でき、改ざん防止のため書き換え不可領域に保存。（F-051）

## 7. データ設計
| テーブル             | 主な項目                                                               | 備考         |
| -------------------- | ---------------------------------------------------------------------- | ------------ |
| work_events          | event_id, device_id, sequence_id, state, timestamp, confidence, status | D-003, D-008 |
| devices              | device_id, line_id, allowed_commands, status, last_seen_at             | D-001        |
| production_sequences | sequence_id, instruction_date, month_serial, process, priority, status | D-002        |
| device_month_serials | device_id, next_serial, updated_by, updated_at                         | D-007        |
| notifications        | notification_id, type, recipients, priority, message, sent_at          | D-003        |
| audit_logs           | log_id, actor, action, target, timestamp, detail                       | N-012        |

![業務サービス層ER図](./業務サービス層ER図.svg)

## 8. 非機能設計
- 応答性能：API-001〜003 の平均応答時間 1 秒以内。（N-003）
- 可用性：冗長化構成でシステム停止無しでメンテナンス実施。（N-004, N-014）
- セキュリティ：多要素認証を必須とし、API 呼び出しにアクセストークンを要求。（N-007, N-008）
- 拡張性：API バージョニングを導入し、新機能追加時も既存クライアント影響を最小化。（N-018）

## 9. 運用・保守
- バッチ：順序リスト取り込みはスケジュールバッチと手動アップロードを併用し、結果は通知する。（I-002）
- 監視：API エラー率、遅延、リトライ回数を監視し、閾値超過で運用チームへ通知。（O-001）
- バージョン管理：API の変更は変更審査を経て、ドキュメントとモックを更新する。（O-002, O-003）

## 10. リスク対応
- R-001：音声認識低下時、手動登録画面を用意し、業務サービス層で端末イベントとの整合性を保持。
- R-003：ラベリング負荷異常時は作業イベントの優先度を調整し、作業者割当を通知。
- R-004：法規制変更時に監査ログ保持期間やアクセス権限を設定可能とする。

---
本設計書の内容を基に詳細定義およびテスト仕様を整備する。
