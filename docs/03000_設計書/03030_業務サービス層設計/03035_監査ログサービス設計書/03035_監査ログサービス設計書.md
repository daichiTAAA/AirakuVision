# 監査ログサービス設計書

## 1. 目的
監査ログサービスは、業務サービス層および関連システムの重要操作を記録し、追跡・証跡管理・コンプライアンス対応を実現する。本書は監査ログサービスの機能設計、データ構造、インターフェース、運用・保守方針を定義する。

## 2. 適用範囲
- 監査ログ収集 API
- ログ正規化・保管・検索
- 改ざん防止機構
- レポーティング・エクスポート
- 監査証跡の保持・削除ポリシー

## 3. 関連要件
- 機能：F-051, F-052, F-053
- 非機能：N-007, N-008, N-009, N-012, N-013, N-017, N-018
- データ：D-003, D-004, D-005, D-008, D-009
- インターフェース：I-001, I-003, I-004
- 運用・保守：O-001, O-002, O-003, O-004
- リスク：R-001, R-003, R-004

## 4. サービスアーキテクチャ
- 実装：FastAPI で受信、Kafka にバッファリング後、Elasticsearch（または OpenSearch）に格納。長期保管は WORM（Write Once Read Many）対応ストレージに日次エクスポート。
- コンポーネント：
  - `AuditIngestAPI`：JSON/OTLP 形式の監査レコードを受信。
  - `Normalizer`：レコードを標準スキーマに変換。PII マスキング、フィールド検証を実施。
  - `Hasher`：各レコードのハッシュおよびチェーンハッシュを生成し、改ざん検知を実現。
  - `Indexer`：検索基盤へ書き込み。インデックスローテーション（日次）。
  - `RetentionManager`：保持期間満了時にアーカイブおよび削除。
  - `ReportingService`：監査レポート・エクスポート機能を提供。

## 5. データスキーマ
| フィールド | 型 | 説明 |
|------------|----|------|
| `audit_id` | UUID | 監査ログ一意識別子 |
| `timestamp` | datetime (UTC) | 操作発生時刻 |
| `actor_type` | enum(user/device/system) | 操作者種別 |
| `actor_id` | string | 利用者 ID / 端末 ID / サービス名 |
| `actor_role` | string | 当時のロール情報 |
| `action` | string | 操作名（例：WORK_EVENT_CREATE, DEVICE_RESET）|
| `target_type` | string | 操作対象の種別（event/device/sequence/config/etc）|
| `target_id` | string | 操作対象の識別子 |
| `request_id` | string | 分散トレーシング ID との連携 |
| `source_ip` | string | リモート IP / 端末情報 |
| `result` | enum(success/failure/warning) | 操作結果 |
| `detail` | jsonb | 付帯情報（変更項目、旧値、新値など）|
| `hash` | string | レコードハッシュ |
| `chain_hash` | string | 直前レコードとのチェーンハッシュ |
| `integrity_status` | enum(valid, tampered, unknown) | 整合性判定 |
| `pii_flag` | bool | 個人情報含有フラグ |
| `sensitivity` | enum(low/medium/high) | 機密度分類 |

## 6. API 設計
| API ID | メソッド | パス | 利用者 | 説明 |
|--------|----------|------|--------|------|
| API-060 | POST | /v1/audit-logs | 内部サービス | 監査ログ受信（バッチ/ストリーム両対応）|
| API-061 | GET | /v1/audit-logs | 監査チーム | 条件検索（期間、actor、action、結果、対象）|
| API-062 | GET | /v1/audit-logs/{id} | 監査チーム | 詳細取得（チェーン検証結果含む）|
| API-063 | POST | /v1/audit-logs/export | 監査チーム | CSV/JSON/署名付きアーカイブ出力 |
| API-064 | POST | /v1/audit-logs/integrity-check | 内部 | 指定期間のハッシュ整合性検証 |
| API-065 | GET | /v1/audit-logs/stats | 監査チーム | KPI（件数、失敗率、リスクレベル分布）|

受信 API（API-060）は一度に最大 500 レコードを受信可能。バルク受信時も順序を保持しチェーンハッシュを更新する。

## 7. 受信フロー
1. 業務サービス・通知サービス・配信層などが API-060 を呼び出し、署名付き JSON を送信。
2. `AuditIngestAPI` が JWT もしくは mTLS 認証を検証。
3. `Normalizer` が必須フィールド・フォーマット検証、PII マスキングを実行。
4. `Hasher` が `hash` と `chain_hash` を生成し、改ざん防止チェーンを構築。
5. `Indexer` が Kafka → Elasticsearch に書き込み。書き込み結果は同期レスポンス（201 Created）で返却。失敗時はリトライキューへ送信。
6. `RetentionManager` がデイリーで WORM ストレージへ暗号化アーカイブを出力。

## 8. 改ざん防止・整合性
- ハッシュアルゴリズム：SHA-512。`chain_hash = SHA512(prev_chain_hash + hash)`。
- 日次でチェーン基点ハッシュ（anchor hash）を生成し、外部タイムスタンプサービスへ登録。
- Integrity Check ジョブ（1 時間毎）がチェーンを検証し、異常時は通知サービスへ Critical アラート。
- WORM ストレージは 5 年ロック。削除要求はコンプライアンス承認後に例外手順で実施。

## 9. 保持・エクスポート
- 標準保持期間：5 年（N-013）。延長が必要なケースは分類に応じて 10 年まで延長。
- エクスポート形式：CSV、JSON Lines、PDF サマリ。電子署名付き ZIP で提供。
- エクスポート要求はキューイングし、大量データは非同期処理。完了後通知サービスで知らせる。

## 10. 非機能設計
- 性能：1 秒間 1,000 レコード受信を想定。バッチ受信はバックプレッシャ制御。
- 可用性：受信 API は冗長化、Kafka バックアップでデータ損失ゼロを目標。
- セキュリティ：TLS1.3、JWT 署名、mTLS。内部サービスのみアクセス可能な VNet に配置。
- 可観測性：取り込み成功率、整合性検証結果、アーカイブ遅延をメトリクス化。

## 11. 運用・監視
- メトリクス：受信件数、失敗件数、整合性異常件数、WORM エクスポート遅延。
- アラート：
  - 受信失敗率 > 1%（5 分平均）
  - Integrity Check 異常検出
  - WORM アーカイブ遅延 > 2 時間
- 運用手順：日次で anchor hash を確認、月次でリストア演習、四半期でアクセス権レビュ。

## 12. テスト観点
- フォーマット検証（欠落フィールド、型不一致）。
- 改ざん検知テスト（chain_hash の手動改変）。
- 大量受信性能、バルク処理。
- エクスポート出力、署名検証。
- リテンション削除シミュレーション（例外手順）。

## 13. リスク対応
- R-001：音声誤認識に伴う誤操作 → 監査ログで操作を追跡し、修正フローを整備。
- R-003：ラベリング負荷に伴う手動修正増大 → 監査ログで修正履歴を分析し、再発防止策を提示。
- R-004：法規制変更 → 保持期間・アクセス権を設定値で管理し、変更時に即時反映。監査チームへのアラートを実装。

---
本設計を基に監査ログ標準スキーマ、OpenAPI 定義、改ざん検知ツール、アーカイブ手順書を整備する。
