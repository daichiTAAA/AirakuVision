# 端末管理サービス設計書

## 1. 目的
端末管理サービスは、装着型デバイスの登録・設定・状態監視・月連番同期・プライバシーゾーン制御を統括し、業務サービス層全体の信頼性を支える。本書は端末管理サービスの機能設計、データ設計、インターフェース設計および非機能要件対応を定義する。

## 2. 適用範囲
- 端末登録・更新・廃止フロー
- 月連番同期・補正
- プライバシーイベント取り扱い
- 端末ステータス・心拍（heartbeat）監視
- 端末向け設定配信（許可コマンド、プロファイル）

## 3. 関連要件
- 機能：F-001, F-002, F-003, F-021, F-022, F-023, F-052, F-053
- 非機能：N-003, N-007, N-008, N-009, N-014, N-015, N-016, N-018
- データ：D-001, D-003, D-007, D-008, D-009
- インターフェース：I-001, I-002, I-004
- 運用・保守：O-001, O-002, O-003
- リスク：R-001, R-002, R-004

## 4. サービスアーキテクチャ
- 実装：FastAPI + PostgreSQL。端末証明書を検証する mTLS エンドポイントを提供。
- コンポーネント：
  - `DeviceRegistry`：登録・更新・廃止処理を担当。
  - `SerialManager`：月連番同期と整合性チェックを実装。
  - `PrivacyController`：プライバシーゾーン入退室イベント処理。
  - `StatusMonitor`：端末心拍、バッテリー、温度等を収集し、閾値判定。
  - `ConfigDistributor`：端末設定の差分配信。Kafka/HTTPS プッシュを両対応。
  - `AuditEmitter`：監査ログサービス連携。

## 5. ライフサイクル
1. **登録**：運用管理者が管理コンソールまたは API を通じて端末を登録。証明書と初期設定を発行。
2. **プロビジョニング**：端末は登録コードを使用して初回認証。端末設定を取得し、アクティブ状態に移行。
3. **運用**：定期的な心拍送信とイベント送信。月連番を同期し、閾値異常で通知サービスに連携。
4. **保守**：ファームウェア更新、設定変更、月連番リセットを実施。履歴を保持。
5. **廃止**：端末が使用停止となった場合に証明書を失効し、状態を `RETIRED` に更新。関連データ保持期間を設定。

## 6. API 設計
| API ID | メソッド | パス | 説明 | 主な入力 | 主な出力 |
|--------|----------|------|------|----------|----------|
| API-020 | POST | /v1/devices | 端末登録 | device_name, line_id, model, operator_id | device_id, enrollment_token |
| API-021 | GET | /v1/devices/{id} | 端末詳細取得 | device_id | device, profile, status |
| API-022 | GET | /v1/devices | 端末一覧 | line_id, status, keyword, page | devices[], pagination |
| API-023 | PATCH | /v1/devices/{id} | プロファイル更新 | allowed_commands, locales, privacy_policy_version | updated_at |
| API-024 | POST | /v1/devices/{id}/heartbeat | 心拍更新 | network_quality, battery_level, temperature, firmware_version | next_expected_serial, commands |
| API-025 | POST | /v1/devices/{id}/month-serial/reset | 月連番リセット申請 | requested_serial, reason, requested_by | request_id, approval_status |
| API-026 | POST | /v1/devices/{id}/privacy-events | プライバシー入退室登録 | zone_id, event_type, detected_at, source | event_id, actions |
| API-027 | POST | /v1/devices/{id}/revoke | 端末失効 | reason, actor | revoked_at |
| API-028 | POST | /v1/devices/{id}/config/ack | 設定取得確認 | applied_profile_version | status |

### 6.1 認証・認可
- 登録・管理系 API：OAuth2 + RBAC（roles: admin, operator）。
- 端末 API：mTLS + クライアントクレデンシャル。`API-024` `API-026` は端末専用スコープ。

### 6.2 心拍処理
- 端末は 30 秒毎（既定値）に `API-024` を送信。最終受信から 90 秒無応答でステータスを `OFFLINE` に変更し、通知サービスへ異常通知。
- 心拍レスポンスで最新月連番および差分設定を返却。設定バージョン差異がある場合は再同期命令を含める。

## 7. 月連番管理
- `SerialManager` は順序管理サービスから最新順序情報を取得し、端末が送信した `requested_serial` を検証。欠番または重複を検出した場合は `WARNING` ステータスで応答し、作業イベントサービスへ補正依頼を送信。
- リセット申請（API-025）は二段階承認。承認者は supervisor 以上。承認・却下結果は通知サービス経由で対象端末と監督者へ連絡。

## 8. プライバシーイベント処理
1. 端末またはビーコンセンサーが `API-026` を呼び出し。
2. `PrivacyController` がゾーンマスタを参照し、対象ゾーンのルールを取得。
3. ルールに基づき配信・記録層へ停止命令を送信し、作業イベントサービスにステータス更新を依頼。
4. イベントを監査ログサービスへ記録し、データマネジメント層の除外対象としてフラグ設定。

## 9. 非機能設計
- 性能：端末同時 2,000 台、心拍スループット 120 req/sec。ピーク時でも応答 500ms 以内。
- 可用性：冗長構成で 99.9%。心拍データは Redis にキャッシュし、DB 障害時も短期間の応答継続。
- 耐障害性：端末はオフライン時に最大 100 件の心拍バッファを保持し、再接続時に送信。サーバ側は重複排除。
- 拡張性：設定項目は JSON Schema によりバリデーションし、将来のフィールド追加に耐える。

## 10. 監視・運用
- メトリクス：心拍受信数、オンライン端末数、月連番リセット申請数、プライバシーイベント数、温度異常件数。
- アラート：
  - 心拍欠損 > 3 回 → 高優先度通知。
  - バッテリー残量 < 15% の端末が 5 台以上 → 運用通知。
  - プライバシー停止が 5 分以上継続 → 緊急通知。
- 運用手順：月次で端末証明書の有効期限を確認し、期限 30 日前に自動通知。

## 11. セキュリティ
- 証明書ローテーション：端末証明書は 6 ヶ月周期で自動更新。失効管理を `device_certificates` で追跡。
- コマンド許可リスト：端末ごとに `allowed_commands` を定義し、認識結果がリスト外の場合は作業イベントサービスで拒否。
- 監査：登録・更新・失効・月連番リセット申請は監査ログサービスへ必須記録。

## 12. テスト観点
- 登録フロー正常系／異常系（重複 ID、証明書失効）。
- 心拍遅延・欠損・大量スパイク処理。
- 月連番リセット承認ワークフロー。
- プライバシーイベント連動（配信停止、再開）。
- 設定配信差分（新コマンド追加、ロールバック）。

## 13. リスク対応
- R-001：音声誤認識で端末ステータスが不整合となる → 心拍レスポンスで最新状態・警告を提示。作業イベントサービスと整合性チェックを定期実行。
- R-002：ネットワーク帯域不足 → 心拍送信間隔を動的調整し、Analytics へ遅延統計を送付。緊急時は軽量プロトコルへ切替。
- R-004：規制変更 → プライバシーポリシー版数を端末へ配信し、同意が必要な場合は端末上で確認フローを提供。

---
本設計を踏まえ、端末管理 API の OpenAPI 定義、mTLS 証明書運用手順、監視ダッシュボードを整備する。
