# 配信・記録層基本設計書

## 1. 目的
本書は、映像・音声ストリームの受信、配信、録画、再生を担う配信・記録層の設計を示す。低遅延配信と確実な録画を両立し、業務サービス層・データマネジメント層との連携方法を定義する。

## 2. 適用範囲
- ストリーミング受付・配信サービス
- 録画ファイル管理
- ライブ監視機能との連携
- メタデータ生成と通知

## 3. 関連要件
- 機能：F-010, F-011, F-030, F-033, F-052, F-053
- 非機能：N-001, N-002, N-004, N-005, N-006, N-017, N-021
- データ：D-004, D-007, D-009
- インターフェース：I-001, I-003
- 運用・保守：O-001, O-004
- リスク：R-002

## 4. アーキテクチャ概要
1. **受信ゲートウェイ**：装着型デバイスからのストリームを受け付け、暗号化通信と認証を実施する。
2. **ライブ配信サービス**：監視 UI への低遅延配信を担当し、同時視聴者数に応じてスケールアウトする。
3. **録画サービス**：受信したストリームを分割保存し、録画完了後にメタデータを生成する。
4. **メタデータサービス**：録画情報と状態イベントを業務サービス層へ通知し、データマネジメント層へ登録要求を送信する。
5. **モニタリングサービス**：遅延・帯域・エラーを計測し、閾値超過時にアラートを発する。

## 5. データフロー
1. ストリーム開始要求を受信し、端末認証および権限確認を実施。
2. 映像・音声データを並列に処理し、ライブ配信サービスへ転送。
3. 録画サービスがフラグメント単位で保存し、保管ポリシーに従ってファイルを管理。
4. 録画完了時にメタデータサービスが録画 ID、開始・終了時刻、端末識別子、型式コード、型色名、機番、生産指示日、月連番などの情報を生成。
5. 生成したメタデータを業務サービス層へ通知し、データマネジメント層に登録 API を呼び出す。

## 6. 機能設計
### 6.1 ストリーム受信
- 認証済み端末のみ受付。
- 遅延を抑えるため、ネットワーク状況に応じてバッファ長を動的調整。
- ストリームエラー時は即時に再送要求を発行し、閾値超過で配信停止を通知。

### 6.2 ライブ配信
- 視聴者ごとのセッション管理を行い、同時視聴数 50 まで性能検証を実施。（N-002）
- 監視 UI からのサムネイル要求に対応するため、一定間隔で静止画像を生成する。

### 6.3 録画管理
- 録画ファイルは時間単位で分割し、メタデータにストレージパスと保存期間を記録。（N-006, N-011）
- 保存期間を超過したファイルは運用ポリシーに従って自動削除し、削除ログを残す。

### 6.4 メタデータ通知
- 業務サービス層に対して録画完了、エラー、プライバシーゾーン停止などのイベントを送信。
- データマネジメント層への登録 API（I-001）を呼び出し、録画 ID と要素作業分析用の索引を渡す。

### 6.5 監視・アラート
- 遅延、パケット損失、エラー率、ストレージ使用量を監視し、しきい値突破で通知を F-052 へ連携。
- フェイルオーバー構成を実装し、障害発生から 5 分以内のサービス再開を目標とする。（N-005）

## 7. データ設計
| 項目           | 内容                                                                  | 関連要件     |
| -------------- | --------------------------------------------------------------------- | ------------ |
| 録画メタデータ | 録画 ID、開始・終了時刻、端末識別子、月連番、保存パス、ファイルサイズ | D-004        |
| ライブ統計     | セッション ID、視聴者ロール、遅延指標、パケット損失率                 | D-009, N-001 |
| エラーイベント | 発生時刻、端末識別子、エラー種別、対応状況                            | F-052, O-001 |

## 8. 非機能設計
- 性能：遅延 1 秒以内（N-001）を満たすため、優先度付きキューと並列処理を採用。
- 可用性：二重化構成、ヘルスチェック、セッション再接続機構で 99.5% 稼働率を確保。（N-004）
- 信頼性：録画ファイルは冗長ストレージへ複製し、整合性チェックを日次で実施。（N-006, D-007）
- 拡張性：新規配信プロトコル追加時は受信ゲートウェイとライブ配信サービスにプラグインを追加するだけで対応できるようモジュール化。（N-017）

## 9. 運用・保守設計
- 監視ダッシュボードでレイテンシ・帯域・エラー率を可視化し、閾値設定を定期的に見直す。（F-053）
- バックアップ：録画ファイルのメタデータを日次でバックアップし、災害対策拠点へ複製する。（O-004）
- キャパシティ計画：利用拡大時はストレージ・配信ノードの追加を行い、事前に負荷テストを実施する。

## 10. セキュリティ
- 受信時に端末証明書を検証し、不正端末の接続を拒否。（N-007）
- ストリームキーは定期的にローテーションし、漏洩時の影響を最小化する。
- 録画ファイルへのアクセスはロールに基づき制御し、閲覧履歴を監査ログへ保存する。（N-012）

## 11. リスク対応
- 帯域不足時はアラートを発し、ビットレートを段階的に調整するとともに、現場ネットワークの改善を促す。（R-002）
- ストレージ不足時は保管期間の短縮案を運用管理者へ提示し、拡張計画を立案する。

---
本設計を基に詳細設計・試験観点を整備すること。
