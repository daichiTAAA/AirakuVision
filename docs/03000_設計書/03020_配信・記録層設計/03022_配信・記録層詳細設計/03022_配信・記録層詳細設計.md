# 配信・記録層 詳細設計書（MediaMTX / MinIO / ADLS / Azure Databricks / FastAPI）

## 1. 目的
本書は、配信・記録層を構成する MediaMTX、MinIO、Azure Data Lake Storage (ADLS)、Azure Databricks、FastAPI を組み合わせた詳細設計を定義する。低遅延配信と耐久性の高い録画保存を両立しつつ、要件定義書で定義された機能・非機能要件を満たすことを目的とする。

## 2. 適用範囲
- MediaMTX を用いた映像・音声ストリーム受信／ライブ配信／録画分割
- MinIO を利用した短期ストレージと冗長化
- ADLS への長期保管とライフサイクル管理
- FastAPI を用いたメタデータ管理・業務サービス層連携
- Azure Databricks を利用した録画品質検証・統計処理バッチ
- 監視、フェイルオーバー、セキュリティ制御

## 3. 要件マッピング
| 要件カテゴリ                                             | 対応内容                                                                                  |
| -------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| 機能 (F-010, F-011, F-030, F-033, F-052, F-053)          | MediaMTX による低遅延配信と録画、FastAPI メタデータ API、監視通知                         |
| 非機能 (N-001, N-002, N-004, N-005, N-006, N-017, N-021) | 遅延 1 秒以内の配信、50 セッション同時接続、二重化構成、録画整合性検証、UI サムネイル提供 |
| データ (D-004, D-007, D-009)                             | 録画メタデータ生成、月連番整合性チェック、配信統計記録                                    |
| インターフェース (I-001, I-003)                          | FastAPI ベースの REST API、ライブ配信エンドポイント                                       |
| 運用 (O-001, O-004)                                      | 24/365 監視、バックアップ／DR ライフサイクル                                              |
| リスク (R-002)                                           | 帯域監視とビットレート制御、ネットワーク負荷時の運用手順                                  |

## 4. システム構成
### 4.1 コンポーネント一覧
| コンポーネント                      | 役割                                                                   | 主な設定ポイント                                      |
| ----------------------------------- | ---------------------------------------------------------------------- | ----------------------------------------------------- |
| MediaMTX Ingest Cluster             | 装着型デバイスから WHIP でストリーム受信、トランスコード不要のまま配信 | WHIP リスナー、WHEP/HLS 出力、録画セクション設定      |
| MediaMTX Recorder                   | ストリームをチャンク化し MinIO へ直接書き込み                          | 録画ディレクトリ、チャンク長、モーション補正          |
| MinIO Bucket (hot-storage)          | 録画ファイルの短期保存、障害時の即時再配信                             | バケットポリシー、バージョニング、Retention 14 日設定 |
| ADLS Storage Account (cold-storage) | ライフサイクル 1 年の長期保管                                          | インクリメンタルコピー、アクセス権限、階層型命名規則  |
| FastAPI Metadata Service            | 録画イベントや統計を管理し業務サービス層へ提供                         | 認証、API スキーマ、ジョブスケジューラ                |
| Azure Databricks Jobs               | 録画整合性チェック、統計処理、メタデータ拡張                           | スケジュール、ノートブック、エラー通知                |
| Monitoring Stack                    | Prometheus 収集、Grafana 可視化、Alertmanager 通知                     | 指標、アラート閾値、オンコールルール                  |

### 4.2 デプロイメントトポロジ
- MediaMTX クラスタは配信ゾーンに 2 ノード構成、負荷分散装置で端末からの接続を分散。
- MinIO は 4 ノード分散モードでホットストレージを構成し、MediaMTX Recorder から S3 互換 API で書き込み。
- ADLS は別リージョン冗長ストレージ (ZRS) を利用し、MinIO から FastAPI + Celery ワーカー経由で非同期転送。
- FastAPI Metadata Service はコンテナ化し、業務サービス層と同一 VNet 内で動作。PostgreSQL 互換 RDB をメタデータ格納に使用。Redis を Celery ブローカーとして併設。
- Azure Databricks はデータマネジメント層と同一サブスクリプションに配置し、FastAPI からバッチジョブを起動。

### 4.3. システム関連図
![配信・記録層システム関連図](./配信・記録層システム関連図.svg)

## 5. データフロー詳細
1. 装着型デバイスが WHIP エンドポイントに接続し、MediaMTX Ingest でセッション確立（TLS + クライアント証明書）。
2. MediaMTX がライブストリームを監視 UI 向け WHEP、およびバックアップ HLS ストリームとして公開。遅延状況は Prometheus Exporter で取得。（N-001）
3. MediaMTX Recorder が MP4 チャンク (デフォルト 60 秒) を生成し、MinIO hot-storage バケットへ書き込み。チャンク作成時にメタデータ (録画 ID、開始時刻、端末 ID) をオブジェクトタグに付与。
4. FastAPI Metadata Service が MediaMTX Webhook を受信し、録画レコードを作成。月連番、工程情報、保存先 URI を登録し業務サービス層へ通知 (I-001)。
5. FastAPI が Celery タスクキューに ADLS 転送タスクを追加。Celery ワーカーが 15 分毎に MinIO から ADLS へ新規チャンクを非同期転送し、成功後に MinIO オブジェクトへ移行済みタグを付与。転送完了時にコールバック API で FastAPI へ通知し、保持期間を更新。
6. Azure Databricks が日次バッチで録画メタデータを解析し、パケット損失率・遅延統計を計算。結果は FastAPI を介してデータマネジメント層へ連携し、ダッシュボード表示用に整形。


## 6. モジュール設計
### 6.1 MediaMTX 設定セクション
- **WHIP/WHEP 設定**：認証に相互 TLS、端末ごとにトークン TTL 30 分。
- **録画設定**：`record.path= s3://hot-storage/{device_id}/{date}/`、チャンク長 60 秒、最大ファイルサイズ 512 MB。
- **プライバシーイベント対応**：FastAPI からの REST 呼び出しで録画プロファイルを一時停止し、停止後に MediaMTX がチャンクを破棄。

### 6.2 MinIO 設計
- バケット：`hot-storage`、バージョニング有効化、サーバサイド暗号化を必須。
- ライフサイクル：14 日未満ファイルはホット維持、ADLS コピー完了後に 14 日経過で削除。
- アクセス制御：MediaMTX 用 IAM ユーザー、FastAPI/Celery 用 IAM ユーザー（読み取り・タグ更新権限）に分離。

### 6.3 ADLS 設計
- フォルダ階層：`/year=YYYY/month=MM/day=DD/device_id/recording_id/`。
- ライフサイクルポリシー：デフォルト 365 日保持、延長対象はタグ `retain=extended` で 730 日保持。
- 監査ログ：ADLS 診断ログを Log Analytics に送信し、アクセス状況を記録。

### 6.4 FastAPI Metadata Service
- 担当 API：
  - `POST /v1/recordings`（MediaMTX Webhook 受付）
  - `PATCH /v1/recordings/{id}/status`（内部ステータス更新）
  - `GET /v1/recordings/{id}`（業務サービス層からの照会）
  - `POST /v1/stream-events`（プライバシーイベント連携）
- データモデル：PostgreSQL に録画テーブル、統計テーブル、タスクステータステーブルを保持。
- **Celery 構成**：
  - ブローカー：Redis（タスクキュー、結果格納）
  - ワーカープロセス数：4（IO集約的なADLS転送を考慮）
  - タスクタイムアウト：30分（大容量ファイル転送対応）
  - リトライポリシー：最大3回、指数バックオフ
- **Celery タスク定義**：
  - `transfer_to_adls_task`：MinIO → ADLS 転送とハッシュ検証
  - `cleanup_minio_task`：転送完了後の MinIO オブジェクト削除
  - `databricks_job_trigger_task`：Azure Databricks ジョブ起動
  - `health_check_task`：定期的なサービス死活監視

### 6.5 Azure Databricks Jobs
- ジョブ 1：録画整合性チェック（チャンク欠落、ファイルサイズ異常）。FastAPI へ結果を通知し、エラー時はアラート発報。
- ジョブ 2：遅延統計算出（平均遅延、95 パーセンタイル、パケット損失率）。結果をデータマネジメント層へ書き込み。
- ジョブ 3：保持期間延長判定（運用ポリシーに基づくタグ更新）。

## 7. インターフェース仕様
### 7.1 Webhook 受信 (MediaMTX → FastAPI)
| 項目           | 内容                                                                 |
| -------------- | -------------------------------------------------------------------- |
| エンドポイント | `POST /internal/hooks/mediamtx`                                      |
| 認証           | 相互 TLS + HMAC ヘッダ                                               |
| ペイロード     | 録画 ID、開始/終了時刻、端末 ID、セッション ID、月連番、チャンク URI |
| 応答           | 200 OK（即時応答）、非同期で業務サービス層へ通知                     |

### 7.2 録画照会 (業務サービス層 → FastAPI)
| パラメータ    | 説明                        |
| ------------- | --------------------------- |
| `monthSerial` | 月連番                      |
| `deviceId`    | 端末識別子                  |
| `state`       | `ACTIVE` `ARCHIVED` `ERROR` |

### 7.3 内部 Celery タスク処理
| タスク                        | 説明                                                               |
| ----------------------------- | ------------------------------------------------------------------ |
| `transfer_to_adls_task`       | MinIO から ADLS へのファイル転送、ハッシュ検証、完了ステータス更新 |
| `cleanup_minio_task`          | 転送完了後の MinIO オブジェクト削除とタグ更新                      |
| `databricks_job_trigger_task` | Azure Databricks ジョブの非同期起動                                |

### 7.4 監視通知 (Prometheus Alertmanager → FastAPI)
- アラート種別：遅延超過、録画失敗、MinIO 容量超過、Celery タスク失敗、ADLS 転送エラー
- FastAPI 通知キュー経由で F-052 へ連携

## 8. 非機能対策
- **遅延**：MediaMTX のバッファ設定を 500 ms、ネットワーク優先度を QoS 制御、負荷状況をリアルタイム監視。（N-001）
- **可用性**：MediaMTX / FastAPI / MinIO にヘルスチェックを設定し、障害時にフェイルオーバー。データ平行書き込みで継続性確保。（N-004, N-005）
- **信頼性**：MinIO -> ADLS コピー完了後にハッシュ照合を実施。FastAPI が不整合を検出した場合は再コピーを指示。（N-006）
- **拡張性**：新フォーマット追加時は MediaMTX プロファイル追加と FastAPI メタデータスキーマ拡張のみで対応。（N-017）
- **UI 要件**：サムネイル生成エンドポイントを MediaMTX 側で 10 秒間隔静止画として提供し、監視画面で利用。（N-021）

## 9. 運用・監視
- Prometheus 指標：ストリーム遅延、セッション数、チャンク書き込み時間、MinIO 容量、Celery タスク実行数・失敗数、ADLS 転送時間。
- Grafana ダッシュボード：ライブ配信状況、録画成功率、Celery タスク統計、ADLS 転送遅延、アラート履歴。
- アラート基準：
  - 遅延 1 秒超過が 60 秒継続 → 高優先度通知
  - 録画失敗が 3 回連続 → 当直オペレーターへ電話連絡
  - MinIO 容量 80% 超過 → 拡張チケット自動発行
  - Celery タスク失敗率 20% 超過 → 編集済み通知（ADLS 転送遅延の可能性）

## 10. セキュリティ
- MediaMTX への接続は端末証明書とトークンを両方利用し、不正端末を遮断。（N-007）
- MinIO/ADLS のアクセス制御は IAM/ACL によりロール別に限定。アクセスログを収集して監査。（N-012）
- FastAPI は認証ゲートウェイ背後に配置し、すべての API コールを監査ログに記録。（F-051）
- プライバシーイベント時、FastAPI が録画禁止タグを付与し、MediaMTX recorder API からチャンクを切断。記録禁止期間を ADLS にも同期。（N-010）

## 11. バックアップ・DR
- MinIO メタデータ：日次バックアップを別リージョンの MinIO または S3 互換ストレージへ転送。
- FastAPI データベース：Point-in-Time Recovery を有効化し、1 日 4 回のスナップショット。
- ADLS データ：地理冗長 (ZRS) により複製。DR ケースでは ADLS から代替 MediaMTX ノードへ直接提供。
- 復旧訓練：半年に 1 回、MinIO 障害を想定したテーブルトップ演習と録画再配信リハーサルを実施。（O-004）

## 12. リスク対応
- **帯域不足 (R-002)**：MediaMTX が遅延を検知した場合、段階的にビットレートを落とし、FastAPI を通じて運用者へ通知。ネットワーク改善が完了するまで低ビットレート維持。
- **録画欠損**：Azure Databricks が欠損を検出すると FastAPI 経由で再配信要求を発行し、可能であれば再取得。不可の場合は業務サービス層へ欠損ステータスを返却。
- **メタデータ同期失敗**：FastAPI がリトライポリシー（指数バックオフ最大 5 回）を持ち、失敗時はアラートを発行し手動復旧手順を実施。

---
本詳細設計は開発・テスト計画のベースラインとして使用し、構成変更時は変更管理プロセスに従い更新する。
