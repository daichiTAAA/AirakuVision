# 装着型デバイス設計書：映像・音声ベース作業分析自動化システム

## 1. 目的
本書は、映像・音声ベース作業分析自動化システムにおける装着型デバイス層の詳細設計を定義する。THINKLETハードウェアの特性を活用し、Kotlin Multiplatformを用いたクロスプラットフォーム対応アプリケーションの実装指針を提供することを目的とする。

## 2. 適用範囲
- 対象：THINKLETデバイス上で動作するAndroidアプリケーション
- 対象外：サーバ側システム、他プラットフォーム（iOS/Desktop）の詳細実装

## 3. 関連ドキュメント
- docs/01000_企画書/01000_企画書.md
- docs/02000_要件定義書/02000_要件定義書.md
- docs/03000_設計書/03000_システム基本設計/03000_システム基本設計.md
- ImageFlowCanvas/docs/0300_設計_アプローチ1/0307_KotlinMultiplatformアプリ設計.md

## 4. 要件対応マトリクス

| 要件ID | 要件内容                   | 実装方針                                     |
| ------ | -------------------------- | -------------------------------------------- |
| F-001  | 端末登録・管理機能         | SharedPreferencesによる端末識別子管理        |
| F-002  | 月連番管理機能             | ローカルDB（SQLDelight）による月連番状態管理 |
| F-003  | プライバシーゾーン検知機能 | 近接センサーとGPSを用いた領域判定            |
| F-010  | 低遅延映像配信             | WHIPプロトコルによるWebRTC配信               |
| F-011  | 映像録画                   | CameraXによる並行録画機能                    |
| F-012  | 音声イベント取得           | THINKLET SDK音声認識とイベント送信           |
| F-013  | 確認プロンプト             | TTSによる音声確認とリプロンプト機能          |
| N-001  | 配信遅延1秒以内            | WebRTCストリーミング最適化                   |
| N-015  | 8時間連続稼働              | バッテリー管理とスリープ制御                 |
| N-016  | オフライン対応             | ローカルキューによる同期機能                 |

## 5. システム全体構成

### 5.1. アーキテクチャ概要

```
┌─────────────────────────────────────────────────────┐
│                THINKLET Device                      │
├─────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────┐│
│  │  Presentation   │  │       Platform Layer       ││
│  │     Layer       │  │  ┌───────────┬───────────┐  ││
│  │ ┌─────────────┐ │  │  │  Camera   │   Audio   │  ││
│  │ │ Compose UI  │ │  │  │ (CameraX) │ (SDK-Audio)│ ││
│  │ │   - Status  │ │  │  ├───────────┼───────────┤  ││
│  │ │   - Control │ │  │  │   LED     │ Gesture   │  ││
│  │ │   - Config  │ │  │  │(SDK-LED)  │(SDK-Gesture)│ ││
│  │ └─────────────┘ │  │  └───────────┴───────────┘  ││
│  └─────────────────┘  └─────────────────────────────┘│
├─────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────┐│
│  │   Domain Layer  │  │       Data Layer            ││
│  │ ┌─────────────┐ │  │  ┌───────────┬───────────┐  ││
│  │ │ UseCase     │ │  │  │LocalDB    │  Network  │  ││
│  │ │ - Stream    │ │  │  │(SQLDelight)│ (gRPC)   │  ││
│  │ │ - Record    │ │  │  ├───────────┼───────────┤  ││
│  │ │ - Event     │ │  │  │   Cache   │   Queue   │  ││
│  │ │ - Sync      │ │  │  │(Memory)   │(Offline)  │  ││
│  │ └─────────────┘ │  │  └───────────┴───────────┘  ││
│  └─────────────────┘  └─────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

### 5.2. Kotlin Multiplatform構成

```
kmp/
├── shared/                          # KMP共通モジュール
│   ├── commonMain/                  # 全プラットフォーム共通
│   │   ├── kotlin/ai/fd/airakuvision/
│   │   │   ├── domain/              # ビジネスロジック
│   │   │   │   ├── model/           # ドメインモデル
│   │   │   │   ├── usecase/         # ユースケース
│   │   │   │   └── repository/      # リポジトリ抽象
│   │   │   ├── data/                # データ層抽象
│   │   │   │   ├── api/             # API抽象
│   │   │   │   └── dto/             # データ転送オブジェクト
│   │   │   └── presentation/        # プレゼンテーション層
│   │   │       ├── viewmodel/       # 共通ViewModel
│   │   │       └── state/           # UI状態管理
│   │   └── sqldelight/              # データベーススキーマ
│   ├── androidMain/                 # 汎用Android実装
│   │   └── kotlin/ai/fd/airakuvision/
│   │       ├── data/                # データ層実装
│   │       │   ├── database/        # SQLDelight実装
│   │       │   ├── network/         # HTTP/gRPC実装
│   │       │   └── storage/         # ローカルストレージ
│   │       ├── platform/            # Android固有機能
│   │       │   ├── permission/      # 権限管理
│   │       │   ├── notification/    # 通知システム
│   │       │   └── lifecycle/       # ライフサイクル管理
│   │       └── ui/                  # Android UI実装
│   │           └── compose/         # Compose UI
│   └── thinkletMain/                # THINKLET特化実装
│       └── kotlin/ai/fd/airakuvision/
│           ├── hardware/            # THINKLET SDK統合
│           │   ├── audio/           # 音声・マイク制御
│           │   ├── camera/          # カメラ制御拡張
│           │   ├── gesture/         # ジェスチャー認識
│           │   ├── led/             # LED制御
│           │   └── sensor/          # センサー統合
│           ├── streaming/           # WebRTC/WHIP配信
│           │   ├── webrtc/          # WebRTC実装
│           │   └── whip/            # WHIP対応
│           ├── power/               # 電源・バッテリー管理
│           └── privacy/             # プライバシーゾーン制御
└── thinkletApp/                     # THINKLETアプリ本体
    ├── build.gradle.kts
    ├── src/main/
    │   ├── kotlin/
    │   │   └── ai/fd/airakuvision/thinklet/
    │   │       ├── ThinkletApplication.kt  # アプリケーションクラス
    │   │       ├── MainActivity.kt         # メインアクティビティ
    │   │       ├── service/               # フォアグラウンドサービス
    │   │       │   ├── StreamingService.kt
    │   │       │   ├── RecordingService.kt
    │   │       │   └── VoiceService.kt
    │   │       ├── receiver/              # ブロードキャストレシーバー
    │   │       └── di/                    # 依存性注入
    │   ├── res/                           # Androidリソース
    │   │   ├── layout/
    │   │   ├── values/
    │   │   ├── drawable/
    │   │   └── raw/                       # 音声ファイル等
    │   └── assets/                        # アセットファイル
    └── AndroidManifest.xml
```

## 6. 機能設計

### 6.1. 映像配信・録画機能

#### 6.1.1. 配信アーキテクチャ

映像配信機能は以下の主要コンポーネントで構成される：

- **StreamingManager**: カメラ制御とWHIPクライアントを統合し、配信セッションを管理する
- **WHIPClient**: WebRTCシグナリングを処理し、メディアストリームの送信を担当する
- **AudioProcessor**: 音声ストリームの前処理と品質調整を実行する

配信品質の管理として、ビットレート動的調整、フレームレート制御、音声品質最適化を実装する。

#### 6.1.2. 録画実装

録画機能は並行処理により配信と同時実行される：

- **RecordingManager**: 録画セッションの開始・停止とメタデータ生成を管理する
- **StorageManager**: ローカルストレージの容量管理と録画ファイルの保存を担当する
- **MetadataGenerator**: 月連番、工程情報、タイムスタンプを含むメタデータを自動生成する

録画ファイルには以下の情報が関連付けられる：録画ID、月連番、工程名、開始・終了時刻、ファイルパス、ファイルサイズ、デバイスID、アップロード状態。

### 6.2. 音声認識・イベント処理

#### 6.2.1. 音声認識実装

音声認識機能は以下の要素で構成される：

- **VoiceCommandProcessor**: 5チャンネルマイクからの音声入力を処理し、音声認識エンジンと連携する
- **CommandParser**: 認識された音声テキストを解析し、定義済みコマンドパターンとマッチングする
- **RecognitionListener**: 音声認識結果を受け取り、信頼度に応じて処理を分岐する

対応する音声コマンドは以下の形式：
- 開始コマンド: 「[デバイス名] 開始 [月連番]」
- 終了コマンド: 「[デバイス名] 終了 [月連番]」
- 中断コマンド: 「[デバイス名] 中断 [理由]」
- 再開コマンド: 「[デバイス名] 再開」

騒音環境下での認識精度向上のため、THINKLETのビームフォーミング機能を活用し、話者方向の音声を強調する。

#### 6.2.2. 確認プロンプト機能

音声認識の信頼度が設定閾値（0.7）を下回る場合、確認プロンプト機能が作動する：

- **VoiceConfirmationManager**: 認識結果の信頼度判定と確認フローを管理する
- **TTS Engine**: 日本語音声合成により確認メッセージを出力する
- **Timeout Management**: 確認応答の制限時間（10秒）を管理する

確認フローは以下の手順で実行される：
1. 音声認識結果の信頼度評価
2. 閾値以下の場合、「[認識テキスト]でよろしいですか？」を音声出力
3. 作業者からの「はい」「いいえ」の応答を待機
4. タイムアウトまたは明確な応答により処理を継続・中止

この機能により、騒音環境下での誤認識を効果的に防止する。

### 6.3. 作業イベント管理

#### 6.3.1. イベント定義

作業イベントは以下の属性で定義される：

**基本属性**:
- イベントID（UUID）、デバイスID、イベント種別、月連番、タイムスタンプ

**音声認識関連**:
- 認識テキスト、信頼度スコア

**管理属性**:
- メタデータ（追加情報のキー・バリューペア）、同期ステータス

**イベント種別**:
- START（開始）、END（終了）、SUSPEND（中断）、RESUME（再開）

**同期ステータス**:
- Pending（同期待機）、InProgress（同期中）、Completed（完了）、Failed（失敗）

#### 6.3.2. イベント管理実装

イベント管理機能は以下の処理フローで動作する：

**イベント登録処理**:
1. 順序検証: 月連番と作業ステップの整合性を確認
2. イベント生成: デバイス情報とタイムスタンプを自動付与
3. ローカル保存: SQLDelightデータベースへの即座保存
4. 同期キュー: サーバ同期のための非同期キューへ追加

**WorkEventManager**の責務:
- 音声コマンドから作業イベントへの変換
- 順序リストとの照合による妥当性検証
- ローカルデータベースへの永続化
- ネットワーク同期の管理

**エラーハンドリング**:
- 順序不整合時の警告表示
- ネットワーク障害時のローカル保存継続
- 重複イベントの検出と除外

### 6.4. センサー統合・プライバシー制御

#### 6.4.1. プライバシーゾーン検知

プライバシーゾーンの検知は複数のセンサーを統合して実現される：

**センサー統合**:
- **GestureSensorManager**: 手の動きや姿勢の変化を検知
- **ProximityManager**: 近接センサーによる物理的近接の監視
- **LocationManager**: GPS情報による地理的位置の管理

**検知ロジック**:
- 近接センサーの闾値判定（プライバシー近接闾値以下でゾーン内判定）
- 特定座標範囲やジオフェンスでの位置判定
- 状態変化のリアルタイム監視と通知

**プライバシー状態管理**:
- Normal（通常状態）: 全機能が有効
- PrivacyZone（プライバシーゾーン）: 映像・音声収集停止

**状態変化時の処理**:
- プライバシーゾーン進入時: 配信・録画・音声収集の一時停止
- プライバシーゾーン退出時: 機能の自動再開

状態変化はリアルタイムでStateFlowにより監視され、関連コンポーネントに即座通知される。

### 6.5. ハードウェア制御

#### 6.5.1. LED制御

THINKLETデバイスのカメラ側LEDの制御機能：

**状態表示機能**:
- 録画状態の表示: 録画中はLED点灯、停止中は消灯
- 配信状態の表示: 接続時は点灯、切断時は消灯、エラー時は500ms間隔で点滅

**LEDController**の機能:
- THINKLET SDKのLedClientを使用したLED制御
- 状態変化に応じた自動LED切り替え
- エラー時の点滅パターン制御
- バッテリー節約のための輝度調整

**視覚フィードバック**:
- 作業者がデバイスの状態を直感的に理解できるように、LEDの点灯パターンで情報を伝達する

#### 6.5.2. ジェスチャー制御

THINKLETのジェスチャーセンサーを活用した操作機能：

**ジェスチャーマッピング**:
- 上から下へのジェスチャー: 録画開始
- 下から上へのジェスチャー: 録画停止
- 左から右へのジェスチャー: 前の月連番へ移動
- 右から左へのジェスチャー: 次の月連番へ移動

**GestureHandler**の機能:
- GestureSensorEventCallbackインターフェースの実装
- ジェスチャーイベントの受信と対応する機能の実行
- 誤動作防止のためのデバウンシング処理
- ジェスチャーの組み合わせ操作のサポート

**操作性の考慮**:
- 作業中の自然な手の動きとの区別
- 意図的なジェスチャーと無意識な動作の判別
- ジェスチャー認識の確実性向上のための闾値調整

## 7. データ管理

### 7.1. ローカルデータベース設計

#### 7.1.1. SQLDelightスキーマ定義

ローカルデータベースは以下のテーブルで構成される：

**work_eventsテーブル**:
- 作業イベントの全情報を保存
- フィールド: ID、デバイスID、イベント種別、月連番、タイムスタンプ、認識テキスト、信頼度、メタデータ（JSON）、同期ステータス

**recording_metadataテーブル**:
- 録画ファイルのメタデータを管理
- フィールド: ID、月連番、作業工程、開始・終了時刻、ファイルパス、ファイルサイズ、デバイスID、アップロード状態

**sequence_dataテーブル**:
- 生産順序リストをキャッシュ保存
- フィールド: 月連番、生産指示日、作業工程、型式、ステータス

**device_configテーブル**:
- デバイス固有の設定情報を保存
- フィールド: キー、値（設定名と設定値のペア）

#### 7.1.2. リポジトリ実装

データアクセス層はリポジトリパターンで実装される：

**LocalWorkEventRepository**の機能:
- SQLDelightデータベースへのイベント保存
- 未同期イベントの取得とフィルタリング
- 同期完了マーキング機能
- JSONシリアライゼーションによるメタデータ管理

**データ変換処理**:
- データベースレコードからドメインモデルへの変換
- タイムスタンプのInstant型とepoch秒の相互変換
- 列挙型と文字列のマッピング

**エラーハンドリング**:
- データベース制約違反時の例外処理
- トランザクションのロールバック機能
- データ整合性チェック

### 7.2. オフライン同期

#### 7.2.1. 同期管理

オフライン対応のための同期メカニズム：

**SyncManager**の機能:
- イベント同期キューの管理（Channelを使用）
- ネットワーク状態の監視と判定
- バックグラウンドでの継続的同期処理

**同期フロー**:
1. イベント登録時に同期キューへ追加
2. ネットワーク接続確認後、サーバへアップロード
3. 成功時はローカルDBで同期完了マーキング
4. 失敗時はリトライ機能で再試行

**ネットワーク管理**:
- ConnectivityManagerでリアルタイム接続状態監視
- ネットワーク復旧時の自動再同期
- Wi-Fi/セルラー通信の優先度制御

**エラーハンドリング**:
- タイムアウト、サーバーエラー、ネットワークエラーの分類処理
- 指数バックオフによるリトライ戦略
- 永続的エラー時のユーザー通知

## 8. ネットワーク通信

### 8.1. gRPC実装

#### 8.1.1. API定義

サーバとの通信はProtocol Buffersを使用したgRPCで実装される：

**WorkEventService**:
- RegisterEvent: 作業イベントの登録
- GetDeviceStatus: デバイス現在状態の取得
- ValidateSequence: 月連番と順序リストの照合

**メッセージ定義**:
- RegisterEventRequest: デバイスID、イベント種別、月連番、タイムスタンプ、認識テキスト、信頼度、メタデータ
- EventType列挙: START、END、SUSPEND、RESUME

#### 8.1.2. クライアント実装

gRPCクライアントは以下の機能を提供する：

**GrpcWorkEventClient**:
- ManagedChannelを使用した持続的接続管理
- コルーチンスタブによる非同期通信
- イベントデータのProtocol Buffers変換
- エラーハンドリングとResult型での結果返却

**接続管理**:
- TLS暗号化通信の設定
- タイムアウト設定とリトライロジック
- 接続プールの再利用とリソース管理

### 8.2. WebRTC実装

#### 8.2.1. WHIP配信

WebRTCを使用した低遅延映像配信の実装：

**WHIPStreamingClient**の機能:
- PeerConnectionの初期化と設定管理
- STUNサーバーとICEサーバーの設定
- メディアストリームのアタッチと管理

**シグナリング処理**:
- SDP Offerの作成とWHIPエンドポイントへの送信
- ICE候補の収集とシグナリングサーバーへの送信
- リモート側からのSDP Answerの処理

**接続状態管理**:
- PeerConnectionStateの監視とイベント処理
- 接続失敗時の自動再接続機能
- ネットワーク品質の監視とアダプティブビットレート制御

**メディア品質管理**:
- 解像度、フレームレート、ビットレートの動的調整
- ネットワーク帯域に応じた品質最適化
- 音声コーデックの選択と設定

## 9. UI設計

### 9.1. Compose UI実装

#### 9.1.1. メイン画面

THINKLET用のUIはシンプルで直感的なデザインとする：

**メイン画面の構成**:
- ステータスカード: デバイス、配信、録画状態の表示
- 作業情報カード: 現在の月連番、工程、開始時刻の表示
- 制御ボタン: 配信・録画の手動制御
- 音声認識カード: リスニング状態、最終認識テキスト、信頼度の表示

**デザイン原則**:
- 大きなフォントサイズで読みやすさを確保
- 高コントラスト配色で現場環境での視認性を向上
- シンプルなレイアウトで操作を簡素化
- 状態変化の視覚的フィードバックを充実

#### 9.1.2. ステータス表示コンポーネント

システム状態の一覧表示機能：

**StatusCard**コンポーネント:
- Material3デザインシステムに準拠
- 配信、録画、バッテリー状態の同時表示
- 状態に応じた色分け（正常、エラー、警告）

**StatusItem**コンポーネント:
- ラベルと状態値のセット表示
- 動的な色変更機能
- アクセシビリティ対応のテキストサイズ

### 9.2. ViewModel実装

MVVMアーキテクチャによるUI状態管理：

**ThinkletMainViewModel**の機能:
- システム状態のStateFlowでの管理
- UIイベントの処理とビジネスロジックへの連携
- 非同期処理のCoroutineScope管理
- システム状態のリアルタイム監視

**主要な機能**:
- 配信開始・停止の制御
- 録画開始・停止の制御
- バッテリー状態の監視
- 音声認識状態の管理

**UI状態管理**:
- ThinkletUiStateデータクラスでの状態統合
- デバイス状態、配信状態、録画状態の包括管理
- 現在の作業情報（月連番、工程、開始時刻）
- 音声認識状態（リスニング、最終認識テキスト、信頼度）

**状態監視**:
- Flowを使用したリアクティブな状態更新
- ViewModelScopeでのライフサイクル管理
- エラーハンドリングとユーザーフィードバック

## 10. 電源・パフォーマンス管理

### 10.1. バッテリー最適化

8時間連続稼働を実現するための電源管理機能：

**PowerManager**の機能:
- 省電力モードの有効化とCPU周波数制限
- 画面輝度の動的調整（现場環境に応じた最適化）
- バックグラウンドアプリの制限と不要サービス停止
- 録画時の電力最適化（CPU/GPU優先度調整、ネットワーク使用量制限）

**自動電源管理**:
- 指定時刻での自動シャットダウン機能
- 作業終了後の自動スタンバイモード移行
- バッテリー残量に応じた機能制限
- Wake Lockの適切な管理と解放

### 10.2. メモリ管理

安定したメモリ使用のための管理機能：

**MemoryManager**の機能:
- LruCacheを使用したメモリキャッシュ管理（最大メモリの1/8を使用）
- 不要キャッシュの定期的クリア
- ガベージコレクションのトリガー制御
- メモリ使用量のリアルタイム監視

**メモリ使用量監視**:
- Runtimeクラスでのメモリ使用状態取得
- 使用率が80%を超えた場合のアラート機能
- 高メモリ使用時の緊急クリーンアップ処理
- OutOfMemoryErrorの予防と対処

## 11. セキュリティ・プライバシー設計

### 11.1. データ暗号化

映像・音声データの保護のための暗号化機能：

**SecurityManager**の機能:
- 録画ファイルの自動暗号化処理
- キー生成と安全なキー管理
- 作業イベントデータの暗号化
- メタデータの選択的暗号化

**暗号化処理フロー**:
1. AES暗号化キーの自動生成
2. 録画ファイルのリアルタイム暗号化
3. 暗号化キーのAndroid Keystoreでの安全保存
4. アップロード時の暗号化ファイル送信

**EncryptedEventデータ構造**:
- イベントID、暗号化されたデバイスID、イベント種別
- 暗号化された月連番、タイムスタンプ
- 暗号化された認識テキスト、信頼度

### 11.2. プライバシーゾーン制御

プライバシー保護のための即座データ保護機能：

**PrivacyController**の機能:
- プライバシーゾーン進入時の全データ収集停止
- 一時ファイルの即座削除処理
- メモリ上の機密データのクリア
- サーバへのプライバシーゾーン状態通知

**データ保護処理**:
1. 配信・録画・音声収集の一時停止
2. カメラキャプチャの一時停止
3. キャッシュディレクトリの再帰的削除
4. メモリ上のバッファデータの上書きクリア

**退出時の再開確認**:
- データ収集再開の明示的確認要求
- ユーザーの同意取得後の機能再開
- プライバシーポリシーの再表示と確認


## 12. テスト設計

### 12.1. 単体テスト

コンポーネント単体の品質保証のためのテスト設計：

**WorkEventManagerTest**:
- MockitoAnnotationsを使用したモックオブジェクトの作成
- イベント登録処理の正常系テスト
- 順序検証失敗時のエラーハンドリングテスト
- ローカルリポジトリへの保存処理確認

**テストケースの設計指針**:
- Given-When-Thenパターンによるテスト構造化
- CoroutineテストのrunTestスコープ使用
- モックオブジェクトの適切な設定と検証
- Result型の成功・失敗ケースの網羅

**カバレッジ目標**:
- ビジネスロジック部分の90%以上
- エラーハンドリング部分の100%
- データ変換処理の95%以上

### 12.2. 統合テスト

システム全体の連携動作確認のためのテスト：

**配信・録画同時実行テスト**:
- StreamingManagerとRecordingManagerの同時動作検証
- 5秒間の継続実行での安定性確認
- リソースの競合状態やメモリリークの検知

**オフライン同期テスト**:
- ネットワーク切断時のローカル保存動作
- ネットワーク復旧時の自動同期動作
- データ整合性の維持確認

**プライバシーゾーンテスト**:
- センサー連携による自動停止・再開動作
- データ削除の完全性検証
- ユーザー同意フローの正常動作

## 13. 運用・監視

### 13.1. ログ出力

デバッグと運用監視のためのログ管理：

**ThinkletLogger**の機能:
- 構造化されたログ出力でのデバッグ情報管理
- 配信イベントの詳細ログとJSON形式でのメタデータ記録
- 作業イベントの種別と月連番のトラッキング
- コンポーネント別エラーログとスタックトレースの記録

**ログレベル管理**:
- INFOレベル: 正常なシステム動作の記録
- ERRORレベル: エラー情報と例外の詳細記録
- DEBUGレベル: 開発・デバッグ時の詳細情報

### 13.2. 状態監視

システムの健全性監視のためのヘルスチェック機能：

**HealthCheckManager**の機能:
- 配信、録画、ネットワーク、ストレージ、バッテリーの各コンポーネントの健全性チェック
- 各コンポーネントの正常・異常状態の判定
- エラー時の詳細メッセージ収集

**コンポーネント健全性チェック**:
- 配信サービスの状態取得とステータス検証
- 録画サービスの動作状態とファイルシステムアクセス
- ネットワーク接続性と通信品質の評価
- ストレージ容量とファイルシステムの状態
- バッテリー残量と電源管理状態

**HealthStatusデータ構造**:
- 各コンポーネントのComponentHealthオブジェクト
- Healthy（正常）、Unhealthy（異常）状態の区別
- エラーメッセージや詳細情報の付与

## 14. デプロイメント・配布

### 14.1. ビルド設定

Kotlin Multiplatformアプリケーションのビルド構成：

**基本設定**:
- アプリケーションID: ai.fd.airakuvision.thinklet
- コンパイルSDK: 34、ミニマムSDK: 27、ターゲットSDK: 34
- バージョン管理: versionCodeとversionNameの連携

**環境別設定**:
- Debugビルド: ローカル開発サーバーへの接続設定
- Releaseビルド: 本番環境サーバーへの接続設定
- ProGuard難読化の有効化と最適化設定

**依存関係管理**:
- THINKLET SDK群: audio、gesture、led、maintenanceの各バージョン管理
- WebRTCライブラリ: io.getstream:stream-webrtc-android
- カメラライブラリ: androidx.camera群のバージョン統一

### 14.2. 権限設定

AndroidManifest.xmlでの必要権限設定：

**メディア関連権限**:
- CAMERA: 映像キャプチャと配信機能
- RECORD_AUDIO: 音声認識と音声コマンド収集

**ネットワーク関連権限**:
- INTERNET: gRPC通信とWebRTC配信
- ACCESS_NETWORK_STATE、ACCESS_WIFI_STATE: ネットワーク状態監視

**システム関連権限**:
- WAKE_LOCK: 長時間録画時のスリープ防止
- FOREGROUND_SERVICE: バックグラウンドでの継続処理
- WRITE_EXTERNAL_STORAGE: 録画ファイルの保存
- ACCESS_FINE_LOCATION: プライバシーゾーン検知

**THINKLETデバイス特有権限**:
- ai.fd.thinklet.permission.HARDWARE_CONTROL: ハードウェア制御機能

## 15. まとめ

本設計書では、映像・音声ベース作業分析自動化システムの装着型デバイス層について、THINKLETハードウェアの特性を活用したKotlin Multiplatformアプリケーションの詳細設計を定義した。

### 15.1. 主要な設計ポイント

1. **クリーンアーキテクチャの採用**: UI・Domain・Data層の分離により、保守性とテスト容易性を確保
2. **THINKLET SDK統合**: 音声認識、ジェスチャー制御、LED表示などの専用機能を活用
3. **リアルタイム配信**: WHIPプロトコルによる低遅延WebRTC配信の実現
4. **オフライン対応**: ローカルDBとキューシステムによる堅牢な同期機能
5. **プライバシー保護**: センサー連携による自動的なデータ保護制御

### 15.2. 今後の拡張方針

- AI機能の統合（エッジAI推論）
- 複数デバイス間連携
- リアルタイム分析機能
- エネルギー効率のさらなる最適化

本設計に基づく実装により、要件定義書で定められた機能要件・非機能要件を満たす、実用的で拡張性の高い装着型デバイスアプリケーションを構築できる。
