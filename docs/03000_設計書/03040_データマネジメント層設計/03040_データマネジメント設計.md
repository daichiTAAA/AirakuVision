# データマネジメント設計書

## 1. 目的
データマネジメント層におけるデータ統合、保存、品質管理、および学習データ生成の設計方針を示す。要件で定義されたデータ要件・品質要件を満たすためのデータモデルと処理フローを明確化する。

## 2. 適用範囲
- データレイク／データウェアハウス構成
- データスキーマ設計
- データパイプライン
- データ品質管理と監査
- 学習データ提供

## 3. 関連要件
- データ：D-001〜D-009
- 機能：F-030, F-031, F-032, F-033, F-043, F-044
- 非機能：N-006, N-011, N-017, N-018
- インターフェース：I-001, I-002, I-003
- 運用・保守：O-001, O-004
- リスク：R-003, R-004

## 4. データアーキテクチャ
1. **生データゾーン**：配信・記録層から受領した録画メタデータとイベントログを格納。
2. **整形データゾーン**：業務サービス層と突合後、分析・可視化に利用できる形式へ変換。
3. **分析ゾーン**：要素作業ラベルやモデル更新履歴を保持し、可視化・学習で利用。
4. **公開 API ゾーン**：可視化層や外部システムへ提供するビューやマートを整備。

## 5. データモデル
### 5.1 コアテーブル
| テーブル | 主キー | 主な項目 | 関連要件 |
|----------|--------|----------|----------|
| fact_work_events | event_id | device_id, sequence_id, state, timestamp, confidence, source, audit_flag | D-003, D-008 |
| dim_devices | device_id | line_id, device_type, status, registered_at | D-001 |
| fact_video_bindings | recording_id | device_id, month_serial, process, instruction_date, storage_path, retention_end_at | D-004, N-011 |
| dim_production_sequences | sequence_id | month_serial, process, instruction_date, priority, status | D-002 |
| fact_task_labels | label_id | recording_id, start_at, end_at, category, annotator_id, review_status | D-005 |
| fact_model_updates | update_id | model_name, training_data_version, metric_name, metric_value, approved_by, approved_at | D-006 |

### 5.2 ビュー・マート
| ビュー | 主な用途 | 元テーブル |
|--------|----------|------------|
| vw_work_timeline | 月連番単位の作業タイムライン可視化 | fact_work_events, fact_video_bindings |
| vw_label_quality | 要素作業ラベルの品質指標確認 | fact_task_labels, fact_model_updates |
| vw_privacy_compliance | プライバシーイベントと録画状況の整合性確認 | fact_video_bindings, fact_work_events |

## 6. データパイプライン
| パイプライン | トリガー | 入力 | 処理内容 | 出力 | 関連要件 |
|--------------|---------|------|----------|------|----------|
| PL-01 録画取り込み | 録画完了通知 | 配信・記録層メタデータ | メタデータ整形、ストレージ登録、整合性検証 | fact_video_bindings | F-030, D-004 |
| PL-02 イベント同期 | 5 分間隔 | 業務サービス API | 作業イベント取得、順序情報との突合 | fact_work_events | F-031, F-033 |
| PL-03 順序データ更新 | 毎日 0:30 | 取り込みファイル | スキーマ検証、差分更新、履歴管理 | dim_production_sequences | F-032, D-002 |
| PL-04 ラベル反映 | ラベリング完了 | 分析 UI からの更新 | ラベル整形、重複チェック、モデル学習用出力 | fact_task_labels, 学習データ | F-043, D-005 |
| PL-05 レポート生成 | 1 時間間隔 | 上記テーブル | KPI 算出、ダッシュボード用データ生成 | vw_work_timeline 等 | F-044 |

## 7. データ品質管理
- 整合性チェック：月連番の欠番・重複を PL-02 で検出し、警告フラグを設定。（D-007）
- 信頼度管理：音声認識信頼度が閾値未満のイベントは確認待ちステータスに分類し、監督者の承認履歴を保持。（D-008）
- 紐付け精度：録画とイベントの結合結果を日次でサンプリングし、誤マッチ率を測定して許容値を 1% 未満に維持。（D-009）

## 8. 保持・ライフサイクル管理
- 映像データ：保持期間 1 年（延長可）。延長設定は運用管理者が更新し、変更履歴を保持。（N-011, O-003）
- イベントログ：5 年保存を基本とし、監査要件に応じて延長。
- ラベルデータ：モデル学習履歴で参照するため無期限保管。ただし利用不可とされたデータは別領域に移動。

## 9. セキュリティ・プライバシー
- データは静止時にも暗号化し、アクセス制御はロールベースで実施。（N-007, N-012）
- プライバシーゾーン内のデータは取り込み対象外とし、誤取得時は即時削除する仕組みを PL-01 に組み込む。（N-010）
- 個人情報を含む列はマスキングビューを提供し、閲覧には承認が必要。（N-012）

## 10. 運用・監視
- パイプライン監視：ジョブの成功・失敗、遅延、処理件数、エラー詳細を監視ダッシュボードで表示。（O-001）
- バックアップ：メタデータテーブルを日次スナップショットとして別拠点へ複製。（O-004）
- 変更管理：スキーマ変更時はデータ契約書を更新し、影響分析とリリース計画を作成。（O-002, N-018）

## 11. リスク対応
- R-003：ラベリング負荷増大時、ラベル反映パイプラインを分散処理し、優先順位付けを実施。
- R-004：法規制変更時に保持期間とマスキングルールを迅速に改定できるよう設定を外部化。

---
本設計を基に詳細スキーマ、ETL 設計、テストケースを策定する。
